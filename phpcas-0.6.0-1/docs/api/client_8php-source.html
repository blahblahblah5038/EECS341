<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>phpCAS: /client.php Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.6 -->
<div class="qindex"><a class="qindex" href="index.html">Main&nbsp;Page</a> | <a class="qindex" href="modules.html">Modules</a> | <a class="qindex" href="hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="annotated.html">Class&nbsp;List</a> | <a class="qindex" href="files.html">File&nbsp;List</a> | <a class="qindex" href="functions.html">Class&nbsp;Members</a> | <a class="qindex" href="globals.html">File&nbsp;Members</a> | <a class="qindex" href="pages.html">Related&nbsp;Pages</a> | <a class="qindex" href="examples.html">Examples</a></div>
<h1>/client.php</h1><a href="client_8php.html">Go to the documentation of this file.</a><div class="fragment"><pre>00001 &lt;?php
00002 
00008 <span class="comment">// include internationalization stuff</span>
00009 include_once(dirname(__FILE__).'/languages/languages.php');
00010 
00011 <span class="comment">// include PGT storage classes</span>
00012 include_once(dirname(__FILE__).'/<a class="code" href="classPGTStorage.html">PGTStorage</a>/pgt-main.php');
00013 
<a name="l00022"></a><a class="code" href="classCASClient.html">00022</a> <span class="keyword">class </span><a class="code" href="classCASClient.html">CASClient</a>
00023 {
00024         
00025         <span class="comment">// XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX</span>
00026         <span class="comment">// XX                                                                    XX</span>
00027         <span class="comment">// XX                          CONFIGURATION                             XX</span>
00028         <span class="comment">// XX                                                                    XX</span>
00029         <span class="comment">// XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX</span>
00030         
00031         <span class="comment">// ########################################################################</span>
00032         <span class="comment">//  HTML OUTPUT</span>
00033         <span class="comment">// ########################################################################</span>
<a name="l00052"></a><a class="code" href="group__internalOutput.html#ga2">00052</a> <span class="comment"></span>        function <a class="code" href="group__internalOutput.html#ga2">HTMLFilterOutput</a>($str)
00053                 {
00054                 $str = str_replace('__CAS_VERSION__',$this-&gt;getServerVersion(),$str);
00055                 $str = str_replace('__PHPCAS_VERSION__',phpCAS::getVersion(),$str);
00056                 $str = str_replace('__SERVER_BASE_URL__',$this-&gt;getServerBaseURL(),$str);
00057                 echo $str;
00058                 }
00059         
<a name="l00068"></a><a class="code" href="group__internalOutput.html#ga0">00068</a>         var <a class="code" href="group__internalOutput.html#ga0">$_output_header</a> = '';
00069         
<a name="l00079"></a><a class="code" href="group__internalOutput.html#ga3">00079</a>         function <a class="code" href="group__internalOutput.html#ga3">printHTMLHeader</a>($title)
00080                 {
00081                 $this-&gt;<a class="code" href="group__internalOutput.html#ga2">HTMLFilterOutput</a>(str_replace('__TITLE__',
00082                         $title,
00083                         (empty($this-&gt;_output_header)
00084                                         ? '&lt;html&gt;&lt;head&gt;&lt;title&gt;__TITLE__&lt;/title&gt;&lt;/head&gt;&lt;body&gt;&lt;h1&gt;__TITLE__&lt;/h1&gt;'
00085                                                         : $this-&gt;_output_header)
00086                 )
00087                 );
00088                 }
00089         
<a name="l00098"></a><a class="code" href="group__internalOutput.html#ga1">00098</a>         var <a class="code" href="group__internalOutput.html#ga1">$_output_footer</a> = '';
00099         
<a name="l00107"></a><a class="code" href="group__internalOutput.html#ga4">00107</a>         function <a class="code" href="group__internalOutput.html#ga4">printHTMLFooter</a>()
00108                 {
00109                 $this-&gt;<a class="code" href="group__internalOutput.html#ga2">HTMLFilterOutput</a>(empty($this-&gt;_output_footer)
00110                         ?('&lt;hr&gt;&lt;address&gt;<a class="code" href="classphpCAS.html">phpCAS</a> __PHPCAS_VERSION__ '.$this-&gt;getString(<a class="code" href="languages_8php.html#a0">CAS_STR_USING_SERVER</a>).' &lt;a href=<span class="stringliteral">"__SERVER_BASE_URL__"</span>&gt;__SERVER_BASE_URL__&lt;/a&gt; (CAS __CAS_VERSION__)&lt;/a&gt;&lt;/address&gt;&lt;/body&gt;&lt;/html&gt;')
00111                                         :$this-&gt;_output_footer);
00112                 }
00113         
<a name="l00121"></a><a class="code" href="group__internalOutput.html#ga5">00121</a>         function <a class="code" href="group__internalOutput.html#ga5">setHTMLHeader</a>($header)
00122                 {
00123                 $this-&gt;_output_header = $header;
00124                 }
00125         
<a name="l00133"></a><a class="code" href="group__internalOutput.html#ga6">00133</a>         function <a class="code" href="group__internalOutput.html#ga6">setHTMLFooter</a>($footer)
00134                 {
00135                 $this-&gt;_output_footer = $footer;
00136                 }
00137         
00139         <span class="comment">// ########################################################################</span>
00140         <span class="comment">//  INTERNATIONALIZATION</span>
00141         <span class="comment">// ########################################################################</span>
<a name="l00156"></a><a class="code" href="group__internalLang.html#ga0">00156</a> <span class="comment"></span>        var <a class="code" href="group__internalLang.html#ga0">$_lang</a> = '';
00157         
<a name="l00165"></a><a class="code" href="group__internalLang.html#ga2">00165</a>         function <a class="code" href="group__internalLang.html#ga2">getLang</a>()
00166                 {
00167                 <span class="keywordflow">if</span> ( empty($this-&gt;_lang) )
00168                         $this-&gt;<a class="code" href="group__internalLang.html#ga4">setLang</a>(<a class="code" href="group__internalLang.html#ga5">PHPCAS_LANG_DEFAULT</a>);
00169                 <span class="keywordflow">return</span> $this-&gt;_lang;
00170                 }
00171         
<a name="l00181"></a><a class="code" href="group__internalLang.html#ga1">00181</a>         var <a class="code" href="group__internalLang.html#ga1">$_strings</a>;
00182         
<a name="l00192"></a><a class="code" href="group__internalLang.html#ga3">00192</a>         function <a class="code" href="group__internalLang.html#ga3">getString</a>($str)
00193                 {
00194                 <span class="comment">// call CASclient::getLang() to be sure the language is initialized</span>
00195                 $this-&gt;<a class="code" href="group__internalLang.html#ga2">getLang</a>();
00196                 
00197                 <span class="keywordflow">if</span> ( !isset($this-&gt;_strings[$str]) ) {
00198                         trigger_error('string `'.$str.<span class="charliteral">'\'</span> not defined <span class="keywordflow">for</span> language `'.$this-&gt;getLang().<span class="charliteral">'\''</span>,E_USER_ERROR);
00199                 }
00200                 <span class="keywordflow">return</span> $this-&gt;<a class="code" href="catalan_8php.html#a0">_strings</a>[$str];
00201                 }
00202         
<a name="l00212"></a><a class="code" href="group__internalLang.html#ga4">00212</a>         function <a class="code" href="group__internalLang.html#ga4">setLang</a>($lang)
00213                 {
00214                 <span class="comment">// include the corresponding language file</span>
00215                 include_once(dirname(__FILE__).'/languages/'.$lang.'.php');
00216                 
00217                 <span class="keywordflow">if</span> ( !is_array($this-&gt;_strings) ) {
00218                         trigger_error('language `'.$lang.<span class="charliteral">'\'</span> is not implemented',E_USER_ERROR);
00219                 }
00220                 $this-&gt;_lang = $lang;
00221                 }
00222         
00224         <span class="comment">// ########################################################################</span>
00225         <span class="comment">//  CAS SERVER CONFIG</span>
00226         <span class="comment">// ########################################################################</span>
<a name="l00256"></a><a class="code" href="group__internalConfig.html#ga0">00256</a> <span class="comment"></span>        var <a class="code" href="group__internalConfig.html#ga0">$_server</a> = array(
00257                 'version' =&gt; -1,
00258                 'hostname' =&gt; 'none',
00259                 'port' =&gt; -1,
00260                 'uri' =&gt; 'none'
00261         );
00262         
<a name="l00268"></a><a class="code" href="group__internalConfig.html#ga1">00268</a>         function <a class="code" href="group__internalConfig.html#ga1">getServerVersion</a>()
00269                 { 
00270                 <span class="keywordflow">return</span> $this-&gt;_server['version']; 
00271                 }
00272         
<a name="l00278"></a><a class="code" href="group__internalConfig.html#ga2">00278</a>         function <a class="code" href="group__internalConfig.html#ga2">getServerHostname</a>()
00279                 { <span class="keywordflow">return</span> $this-&gt;_server['hostname']; }
00280         
<a name="l00286"></a><a class="code" href="group__internalConfig.html#ga3">00286</a>         function <a class="code" href="group__internalConfig.html#ga3">getServerPort</a>()
00287                 { <span class="keywordflow">return</span> $this-&gt;_server['port']; }
00288         
<a name="l00294"></a><a class="code" href="group__internalConfig.html#ga4">00294</a>         function <a class="code" href="group__internalConfig.html#ga4">getServerURI</a>()
00295                 { <span class="keywordflow">return</span> $this-&gt;_server['uri']; }
00296         
<a name="l00302"></a><a class="code" href="group__internalConfig.html#ga5">00302</a>         function <a class="code" href="group__internalConfig.html#ga5">getServerBaseURL</a>()
00303                 { 
00304                 <span class="comment">// the URL is build only when needed</span>
00305                 <span class="keywordflow">if</span> ( empty($this-&gt;_server['base_url']) ) {
00306                         $this-&gt;_server['base_url'] = 'https:<span class="comment">//'</span>
00307                                 .$this-&gt;getServerHostname()
00308                                 .<span class="charliteral">':'</span>
00309                                 .$this-&gt;getServerPort()
00310                                 .$this-&gt;getServerURI();
00311                 }
00312                 <span class="keywordflow">return</span> $this-&gt;_server['base_url']; 
00313                 }
00314         
<a name="l00324"></a><a class="code" href="group__internalConfig.html#ga6">00324</a>         function <a class="code" href="group__internalConfig.html#ga6">getServerLoginURL</a>($gateway=<span class="keyword">false</span>,$renew=<span class="keyword">false</span>) {
00325                 <a class="code" href="group__internalDebug.html#ga4">phpCAS::traceBegin</a>();
00326                 <span class="comment">// the URL is build only when needed</span>
00327                 <span class="keywordflow">if</span> ( empty($this-&gt;_server['login_url']) ) {
00328                         $this-&gt;_server['login_url'] = $this-&gt;<a class="code" href="group__internalConfig.html#ga5">getServerBaseURL</a>();
00329                         $this-&gt;_server['login_url'] .= 'login?service=';
00330                         <span class="comment">// $this-&gt;_server['login_url'] .= preg_replace('/&amp;/','%26',$this-&gt;getURL());</span>
00331                         $this-&gt;_server['login_url'] .= urlencode($this-&gt;getURL());
00332                         <span class="keywordflow">if</span>($renew) {
00333                                 <span class="comment">// It is recommended that when the "renew" parameter is set, its value be "true"</span>
00334                                 $this-&gt;_server['login_url'] .= '&amp;renew=<span class="keyword">true</span>';
00335                         } elseif ($gateway) {
00336                                 <span class="comment">// It is recommended that when the "gateway" parameter is set, its value be "true"</span>
00337                                 $this-&gt;_server['login_url'] .= '&amp;gateway=<span class="keyword">true</span>';
00338                         }
00339                 }
00340                 <a class="code" href="group__internalDebug.html#ga5">phpCAS::traceEnd</a>($this-&gt;_server['login_url']);
00341                 <span class="keywordflow">return</span> $this-&gt;_server['login_url'];
00342         } 
00343         
<a name="l00350"></a><a class="code" href="group__internalConfig.html#ga7">00350</a>         function <a class="code" href="group__internalConfig.html#ga7">setServerLoginURL</a>($url)
00351                 {
00352                 <span class="keywordflow">return</span> $this-&gt;_server['login_url'] = $url;
00353                 }
00354         
<a name="l00360"></a><a class="code" href="group__internalConfig.html#ga8">00360</a>         function <a class="code" href="group__internalConfig.html#ga8">getServerServiceValidateURL</a>()
00361                 { 
00362                 <span class="comment">// the URL is build only when needed</span>
00363                 <span class="keywordflow">if</span> ( empty($this-&gt;_server['service_validate_url']) ) {
00364                         <span class="keywordflow">switch</span> ($this-&gt;<a class="code" href="group__internalConfig.html#ga1">getServerVersion</a>()) {
00365                                 <span class="keywordflow">case</span> <a class="code" href="group__public.html#ga1">CAS_VERSION_1_0</a>:
00366                                         $this-&gt;_server['service_validate_url'] = $this-&gt;<a class="code" href="group__internalConfig.html#ga5">getServerBaseURL</a>().'validate';
00367                                         <span class="keywordflow">break</span>;
00368                                 <span class="keywordflow">case</span> <a class="code" href="group__public.html#ga2">CAS_VERSION_2_0</a>:
00369                                         $this-&gt;_server['service_validate_url'] = $this-&gt;<a class="code" href="group__internalConfig.html#ga5">getServerBaseURL</a>().'serviceValidate';
00370                                         <span class="keywordflow">break</span>;
00371                         }
00372                 }
00373                 <span class="comment">//      return $this-&gt;_server['service_validate_url'].'?service='.preg_replace('/&amp;/','%26',$this-&gt;getURL()); </span>
00374                 <span class="keywordflow">return</span> $this-&gt;_server['service_validate_url'].'?service='.urlencode($this-&gt;getURL()); 
00375                 }
00376         
<a name="l00382"></a><a class="code" href="group__internalConfig.html#ga9">00382</a>         function <a class="code" href="group__internalConfig.html#ga9">getServerProxyValidateURL</a>()
00383                 { 
00384                 <span class="comment">// the URL is build only when needed</span>
00385                 <span class="keywordflow">if</span> ( empty($this-&gt;_server['proxy_validate_url']) ) {
00386                         <span class="keywordflow">switch</span> ($this-&gt;<a class="code" href="group__internalConfig.html#ga1">getServerVersion</a>()) {
00387                                 <span class="keywordflow">case</span> <a class="code" href="group__public.html#ga1">CAS_VERSION_1_0</a>:
00388                                         $this-&gt;_server['proxy_validate_url'] = '';
00389                                         <span class="keywordflow">break</span>;
00390                                 <span class="keywordflow">case</span> <a class="code" href="group__public.html#ga2">CAS_VERSION_2_0</a>:
00391                                         $this-&gt;_server['proxy_validate_url'] = $this-&gt;<a class="code" href="group__internalConfig.html#ga5">getServerBaseURL</a>().'proxyValidate';
00392                                         <span class="keywordflow">break</span>;
00393                         }
00394                 }
00395                 <span class="comment">//      return $this-&gt;_server['proxy_validate_url'].'?service='.preg_replace('/&amp;/','%26',$this-&gt;getURL()); </span>
00396                 <span class="keywordflow">return</span> $this-&gt;_server['proxy_validate_url'].'?service='.urlencode($this-&gt;getURL()); 
00397                 }
00398         
<a name="l00404"></a><a class="code" href="group__internalConfig.html#ga10">00404</a>         function <a class="code" href="group__internalConfig.html#ga10">getServerProxyURL</a>()
00405                 { 
00406                 <span class="comment">// the URL is build only when needed</span>
00407                 <span class="keywordflow">if</span> ( empty($this-&gt;_server['proxy_url']) ) {
00408                         <span class="keywordflow">switch</span> ($this-&gt;<a class="code" href="group__internalConfig.html#ga1">getServerVersion</a>()) {
00409                                 <span class="keywordflow">case</span> <a class="code" href="group__public.html#ga1">CAS_VERSION_1_0</a>:
00410                                         $this-&gt;_server['proxy_url'] = '';
00411                                         <span class="keywordflow">break</span>;
00412                                 <span class="keywordflow">case</span> <a class="code" href="group__public.html#ga2">CAS_VERSION_2_0</a>:
00413                                         $this-&gt;_server['proxy_url'] = $this-&gt;<a class="code" href="group__internalConfig.html#ga5">getServerBaseURL</a>().'proxy';
00414                                         <span class="keywordflow">break</span>;
00415                         }
00416                 }
00417                 <span class="keywordflow">return</span> $this-&gt;_server['proxy_url']; 
00418                 }
00419         
<a name="l00425"></a><a class="code" href="group__internalConfig.html#ga11">00425</a>         function <a class="code" href="group__internalConfig.html#ga11">getServerLogoutURL</a>()
00426                 { 
00427                 <span class="comment">// the URL is build only when needed</span>
00428                 <span class="keywordflow">if</span> ( empty($this-&gt;_server['logout_url']) ) {
00429                         $this-&gt;_server['logout_url'] = $this-&gt;<a class="code" href="group__internalConfig.html#ga5">getServerBaseURL</a>().'logout';
00430                 }
00431                 <span class="keywordflow">return</span> $this-&gt;_server['logout_url']; 
00432                 }
00433         
<a name="l00440"></a><a class="code" href="group__internalConfig.html#ga12">00440</a>         function <a class="code" href="group__internalConfig.html#ga12">setServerLogoutURL</a>($url)
00441                 {
00442                 <span class="keywordflow">return</span> $this-&gt;_server['logout_url'] = $url;
00443                 }
00444         
<a name="l00450"></a><a class="code" href="group__internalConfig.html#ga13">00450</a>         function <a class="code" href="group__internalConfig.html#ga13">isHttps</a>() {
00451                 <span class="comment">//if ( isset($_SERVER['HTTPS']) &amp;&amp; !empty($_SERVER['HTTPS']) ) {</span>
00452                 <span class="comment">//0.4.24 by Hinnack</span>
00453                 <span class="keywordflow">if</span> ( isset($_SERVER['HTTPS']) &amp;&amp; !empty($_SERVER['HTTPS']) &amp;&amp; $_SERVER['HTTPS'] == 'on') {
00454                         <span class="keywordflow">return</span> <span class="keyword">true</span>;
00455                 } <span class="keywordflow">else</span> {
00456                         <span class="keywordflow">return</span> <span class="keyword">false</span>;
00457                 }
00458         }
00459         
00460         <span class="comment">// ########################################################################</span>
00461         <span class="comment">//  CONSTRUCTOR</span>
00462         <span class="comment">// ########################################################################</span>
<a name="l00477"></a><a class="code" href="group__internalConfig.html#ga14">00477</a> <span class="comment"></span>        function <a class="code" href="group__internalConfig.html#ga14">CASClient</a>(
00478                                            $server_version,
00479                                            $proxy,
00480                                            $server_hostname,
00481                                            $server_port,
00482                                            $server_uri,
00483                                            $start_session = <span class="keyword">true</span>) {
00484                 
00485                 <a class="code" href="group__internalDebug.html#ga4">phpCAS::traceBegin</a>();
00486                 
00487                 <span class="comment">//activate session mechanism if desired</span>
00488                 <span class="keywordflow">if</span> ($start_session) {
00489                         session_start();
00490                 }
00491                 
00492                 $this-&gt;_proxy = $proxy;
00493                 
00494                 <span class="comment">//check version</span>
00495                 <span class="keywordflow">switch</span> ($server_version) {
00496                         <span class="keywordflow">case</span> <a class="code" href="group__public.html#ga1">CAS_VERSION_1_0</a>:
00497                                 <span class="keywordflow">if</span> ( $this-&gt;<a class="code" href="group__internalProxy.html#ga2">isProxy</a>() )
00498                                         <a class="code" href="group__internalDebug.html#ga2">phpCAS::error</a>('CAS proxies are not supported in CAS '
00499                                                 .$server_version);
00500                                 <span class="keywordflow">break</span>;
00501                         <span class="keywordflow">case</span> <a class="code" href="group__public.html#ga2">CAS_VERSION_2_0</a>:
00502                                 <span class="keywordflow">break</span>;
00503                         <span class="keywordflow">default</span>:
00504                                 <a class="code" href="group__internalDebug.html#ga2">phpCAS::error</a>('<span class="keyword">this</span> version of CAS (`'
00505                                         .$server_version
00506                                         .<span class="charliteral">'\'</span>) is not supported by <a class="code" href="classphpCAS.html">phpCAS</a> '
00507                                         .phpCAS::getVersion());
00508                 }
00509                 $this-&gt;_server['version'] = $server_version;
00510                 
00511                 <span class="comment">//check hostname</span>
00512                 <span class="keywordflow">if</span> ( empty($server_hostname) 
00513                                 || !preg_match('/[\.\d\-abcdefghijklmnopqrstuvwxyz]*/',$server_hostname) ) {
00514                         <a class="code" href="group__internalDebug.html#ga2">phpCAS::error</a>('bad CAS server hostname (`'.$server_hostname.<span class="charliteral">'\'</span>)');
00515                 }
00516                 $this-&gt;_server['hostname'] = $server_hostname;
00517                 
00518                 <span class="comment">//check port</span>
00519                 <span class="keywordflow">if</span> ( $server_port == 0 
00520                         || !is_int($server_port) ) {
00521                         <a class="code" href="group__internalDebug.html#ga2">phpCAS::error</a>('bad CAS server port (`'.$server_hostname.<span class="charliteral">'\'</span>)');
00522                 }
00523                 $this-&gt;_server['port'] = $server_port;
00524                 
00525                 <span class="comment">//check URI</span>
00526                 <span class="keywordflow">if</span> ( !preg_match('/[\.\d\-_abcdefghijklmnopqrstuvwxyz\/]*/',$server_uri) ) {
00527                         <a class="code" href="group__internalDebug.html#ga2">phpCAS::error</a>('bad CAS server URI (`'.$server_uri.<span class="charliteral">'\'</span>)');
00528                 }
00529                 <span class="comment">//add leading and trailing `/' and remove doubles      </span>
00530                 $server_uri = preg_replace('/\/\<span class="comment">//','/','/'.$server_uri.'/');</span>
00531                 $this-&gt;_server['uri'] = $server_uri;
00532                 
00533                 <span class="comment">//set to callback mode if PgtIou and PgtId CGI GET parameters are provided </span>
00534                 if ( $this-&gt;isProxy() ) {
00535                         $this-&gt;<a class="code" href="group__internalCallback.html#ga2">setCallbackMode</a>(!empty($_GET['pgtIou'])&amp;&amp;!empty($_GET['pgtId']));
00536                 }
00537                 
00538                 <span class="keywordflow">if</span> ( $this-&gt;<a class="code" href="group__internalCallback.html#ga3">isCallbackMode</a>() ) {
00539                         <span class="comment">//callback mode: check that phpCAS is secured</span>
00540                         <span class="keywordflow">if</span> ( !$this-&gt;<a class="code" href="group__internalConfig.html#ga13">isHttps</a>() ) {
00541                                 <a class="code" href="group__internalDebug.html#ga2">phpCAS::error</a>('CAS proxies must be secured to use <a class="code" href="classphpCAS.html">phpCAS</a>; PGT\'s will not be received from the CAS server');
00542                         }
00543                 } <span class="keywordflow">else</span> {
00544                         <span class="comment">//normal mode: get ticket and remove it from CGI parameters for developpers</span>
00545                         $ticket = (isset($_GET['ticket']) ? $_GET['ticket'] : null);
00546                         <span class="keywordflow">switch</span> ($this-&gt;<a class="code" href="group__internalConfig.html#ga1">getServerVersion</a>()) {
00547                                 <span class="keywordflow">case</span> <a class="code" href="group__public.html#ga1">CAS_VERSION_1_0</a>: <span class="comment">// check for a Service Ticket</span>
00548                                         <span class="keywordflow">if</span>( preg_match('/^ST-/',$ticket) ) {
00549                                                 <a class="code" href="group__internalDebug.html#ga3">phpCAS::trace</a>('ST \''.$ticket.<span class="charliteral">'\'</span> found');
00550                                                 <span class="comment">//ST present</span>
00551                                                 $this-&gt;<a class="code" href="group__internalBasic.html#ga5">setST</a>($ticket);
00552                                                 <span class="comment">//ticket has been taken into account, unset it to hide it to applications</span>
00553                                                 unset($_GET['ticket']);
00554                                         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> ( !empty($ticket) ) {
00555                                                 <span class="comment">//ill-formed ticket, halt</span>
00556                                                 <a class="code" href="group__internalDebug.html#ga2">phpCAS::error</a>('ill-formed ticket found in the URL (ticket=`'.htmlentities($ticket).<span class="charliteral">'\'</span>)');
00557                                         }
00558                                         <span class="keywordflow">break</span>;
00559                                 <span class="keywordflow">case</span> <a class="code" href="group__public.html#ga2">CAS_VERSION_2_0</a>: <span class="comment">// check for a Service or Proxy Ticket</span>
00560                                         <span class="keywordflow">if</span>( preg_match('/^[SP]T-/',$ticket) ) {
00561                                                 <a class="code" href="group__internalDebug.html#ga3">phpCAS::trace</a>('ST or PT \''.$ticket.<span class="charliteral">'\'</span> found');
00562                                                 $this-&gt;<a class="code" href="group__internalProxied.html#ga2">setPT</a>($ticket);
00563                                                 unset($_GET['ticket']);
00564                                         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> ( !empty($ticket) ) {
00565                                                 <span class="comment">//ill-formed ticket, halt</span>
00566                                                 <a class="code" href="group__internalDebug.html#ga2">phpCAS::error</a>('ill-formed ticket found in the URL (ticket=`'.htmlentities($ticket).<span class="charliteral">'\'</span>)');
00567                                         } 
00568                                         <span class="keywordflow">break</span>;
00569                         }
00570                 }
00571                 <a class="code" href="group__internalDebug.html#ga5">phpCAS::traceEnd</a>();
00572         }
00573         
00576         <span class="comment">// XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX</span>
00577         <span class="comment">// XX                                                                    XX</span>
00578         <span class="comment">// XX                           AUTHENTICATION                           XX</span>
00579         <span class="comment">// XX                                                                    XX</span>
00580         <span class="comment">// XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX</span>
00581         
<a name="l00594"></a><a class="code" href="group__internalAuthentication.html#ga0">00594</a>         var <a class="code" href="group__internalAuthentication.html#ga0">$_user</a> = '';
00595         
<a name="l00603"></a><a class="code" href="group__internalAuthentication.html#ga2">00603</a>         function <a class="code" href="group__internalAuthentication.html#ga2">setUser</a>($user)
00604                 {
00605                 $this-&gt;_user = $user;
00606                 }
00607         
<a name="l00615"></a><a class="code" href="group__internalAuthentication.html#ga3">00615</a>         function <a class="code" href="group__internalAuthentication.html#ga3">getUser</a>()
00616                 {
00617                 <span class="keywordflow">if</span> ( empty($this-&gt;_user) ) {
00618                         <a class="code" href="group__internalDebug.html#ga2">phpCAS::error</a>('<span class="keyword">this</span> method should be used only after '.__CLASS__.'::forceAuthentication() or '.__CLASS__.'::isAuthenticated()');
00619                 }
00620                 <span class="keywordflow">return</span> $this-&gt;_user;
00621                 }
00622         
<a name="l00629"></a><a class="code" href="group__internalAuthentication.html#ga4">00629</a>         function <a class="code" href="group__internalAuthentication.html#ga4">renewAuthentication</a>(){
00630                 <a class="code" href="group__internalDebug.html#ga4">phpCAS::traceBegin</a>();
00631                 <span class="comment">// Either way, the user is authenticated by CAS</span>
00632                 <span class="keywordflow">if</span>( isset( $_SESSION['<a class="code" href="classphpCAS.html">phpCAS</a>']['auth_checked'] ) )
00633                         unset($_SESSION['<a class="code" href="classphpCAS.html">phpCAS</a>']['auth_checked']);
00634                 <span class="keywordflow">if</span> ( $this-&gt;<a class="code" href="group__internalAuthentication.html#ga8">isAuthenticated</a>() ) {
00635                         <a class="code" href="group__internalDebug.html#ga3">phpCAS::trace</a>('user already authenticated; renew');
00636                         $this-&gt;<a class="code" href="group__internalAuthentication.html#ga11">redirectToCas</a>(<span class="keyword">false</span>,<span class="keyword">true</span>);
00637                 } <span class="keywordflow">else</span> {
00638                         $this-&gt;<a class="code" href="group__internalAuthentication.html#ga11">redirectToCas</a>();
00639                 }
00640                 <a class="code" href="group__internalDebug.html#ga5">phpCAS::traceEnd</a>();
00641         }
00642 
<a name="l00649"></a><a class="code" href="group__internalAuthentication.html#ga5">00649</a>         function <a class="code" href="group__internalAuthentication.html#ga5">forceAuthentication</a>()
00650                 {
00651                 <a class="code" href="group__internalDebug.html#ga4">phpCAS::traceBegin</a>();
00652                 
00653                 <span class="keywordflow">if</span> ( $this-&gt;<a class="code" href="group__internalAuthentication.html#ga8">isAuthenticated</a>() ) {
00654                         <span class="comment">// the user is authenticated, nothing to be done.</span>
00655                         <a class="code" href="group__internalDebug.html#ga3">phpCAS::trace</a>('no need to authenticate');
00656                         $res = TRUE;
00657                 } <span class="keywordflow">else</span> {
00658                         <span class="comment">// the user is not authenticated, redirect to the CAS server</span>
00659                         <span class="keywordflow">if</span> (isset($_SESSION['<a class="code" href="classphpCAS.html">phpCAS</a>']['auth_checked'])) {
00660                                 unset($_SESSION['<a class="code" href="classphpCAS.html">phpCAS</a>']['auth_checked']);
00661                         }
00662                         $this-&gt;<a class="code" href="group__internalAuthentication.html#ga11">redirectToCas</a>(FALSE<span class="comment">/* no gateway */</span>);    
00663                         <span class="comment">// never reached</span>
00664                         $res = FALSE;
00665                 }
00666                 <a class="code" href="group__internalDebug.html#ga5">phpCAS::traceEnd</a>($res);
00667                 <span class="keywordflow">return</span> $res;
00668                 }
00669         
<a name="l00676"></a><a class="code" href="group__internalAuthentication.html#ga1">00676</a>         var <a class="code" href="group__internalAuthentication.html#ga1">$_cache_times_for_auth_recheck</a> = 0;
00677         
<a name="l00685"></a><a class="code" href="group__internalAuthentication.html#ga6">00685</a>         function <a class="code" href="group__internalAuthentication.html#ga6">setCacheTimesForAuthRecheck</a>($n)
00686                 {
00687                 $this-&gt;_cache_times_for_auth_recheck = $n;
00688                 }
00689         
<a name="l00695"></a><a class="code" href="group__internalAuthentication.html#ga7">00695</a>         function <a class="code" href="group__internalAuthentication.html#ga7">checkAuthentication</a>()
00696                 {
00697                 <a class="code" href="group__internalDebug.html#ga4">phpCAS::traceBegin</a>();
00698                 
00699                 <span class="keywordflow">if</span> ( $this-&gt;<a class="code" href="group__internalAuthentication.html#ga8">isAuthenticated</a>() ) {
00700                         <a class="code" href="group__internalDebug.html#ga3">phpCAS::trace</a>('user is authenticated');
00701                         $res = TRUE;
00702                 } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (isset($_SESSION['<a class="code" href="classphpCAS.html">phpCAS</a>']['auth_checked'])) {
00703                         <span class="comment">// the previous request has redirected the client to the CAS server with gateway=true</span>
00704                         unset($_SESSION['<a class="code" href="classphpCAS.html">phpCAS</a>']['auth_checked']);
00705                         $res = FALSE;
00706                 } <span class="keywordflow">else</span> {
00707                         <span class="comment">//        $_SESSION['phpCAS']['auth_checked'] = true;</span>
00708                         <span class="comment">//          $this-&gt;redirectToCas(TRUE/* gateway */);    </span>
00709                         <span class="comment">//          // never reached</span>
00710                         <span class="comment">//          $res = FALSE;</span>
00711                         <span class="comment">// avoid a check against CAS on every request</span>
00712                         <span class="keywordflow">if</span> (! isset($_SESSION['<a class="code" href="classphpCAS.html">phpCAS</a>']['unauth_count']) )
00713                                 $_SESSION['<a class="code" href="classphpCAS.html">phpCAS</a>']['unauth_count'] = -2; <span class="comment">// uninitialized</span>
00714                         
00715                         <span class="keywordflow">if</span> (($_SESSION['<a class="code" href="classphpCAS.html">phpCAS</a>']['unauth_count'] != -2 &amp;&amp; $this-&gt;_cache_times_for_auth_recheck == -1) 
00716                                         || ($_SESSION['<a class="code" href="classphpCAS.html">phpCAS</a>']['unauth_count'] &gt;= 0 &amp;&amp; $_SESSION['<a class="code" href="classphpCAS.html">phpCAS</a>']['unauth_count'] &lt; $this-&gt;_cache_times_for_auth_recheck))
00717                         {
00718                                 $res = FALSE;
00719                                 
00720                                 <span class="keywordflow">if</span> ($this-&gt;_cache_times_for_auth_recheck != -1)
00721                                 {
00722                                         $_SESSION['<a class="code" href="classphpCAS.html">phpCAS</a>']['unauth_count']++;
00723                                         <a class="code" href="group__internalDebug.html#ga3">phpCAS::trace</a>('user is not authenticated (cached <span class="keywordflow">for</span> '.$_SESSION['<a class="code" href="classphpCAS.html">phpCAS</a>']['unauth_count'].' times of '.$this-&gt;_cache_times_for_auth_recheck.<span class="charliteral">')'</span>);
00724                                 }
00725                                 <span class="keywordflow">else</span>
00726                                 {
00727                                         <a class="code" href="group__internalDebug.html#ga3">phpCAS::trace</a>('user is not authenticated (cached <span class="keywordflow">for</span> until login pressed)');
00728                                 }
00729                         }
00730                         <span class="keywordflow">else</span>
00731                         {
00732                                 $_SESSION['<a class="code" href="classphpCAS.html">phpCAS</a>']['unauth_count'] = 0;
00733                                 $_SESSION['<a class="code" href="classphpCAS.html">phpCAS</a>']['auth_checked'] = <span class="keyword">true</span>;
00734                                 <a class="code" href="group__internalDebug.html#ga3">phpCAS::trace</a>('user is not authenticated (cache reset)');
00735                                 $this-&gt;<a class="code" href="group__internalAuthentication.html#ga11">redirectToCas</a>(TRUE<span class="comment">/* gateway */</span>);        
00736                                 <span class="comment">// never reached</span>
00737                                 $res = FALSE;
00738                         }
00739                 }
00740                 <a class="code" href="group__internalDebug.html#ga5">phpCAS::traceEnd</a>($res);
00741                 <span class="keywordflow">return</span> $res;
00742                 }
00743         
<a name="l00752"></a><a class="code" href="group__internalAuthentication.html#ga8">00752</a>         function <a class="code" href="group__internalAuthentication.html#ga8">isAuthenticated</a>()
00753                 {
00754                 <a class="code" href="group__internalDebug.html#ga4">phpCAS::traceBegin</a>();
00755                 $res = FALSE;
00756                 $validate_url = '';
00757                 
00758                 <span class="keywordflow">if</span> ( $this-&gt;<a class="code" href="group__internalAuthentication.html#ga10">wasPreviouslyAuthenticated</a>() ) {
00759                         <span class="comment">// the user has already (previously during the session) been </span>
00760                         <span class="comment">// authenticated, nothing to be done.</span>
00761                         <a class="code" href="group__internalDebug.html#ga3">phpCAS::trace</a>('user was already authenticated, no need to look <span class="keywordflow">for</span> tickets');
00762                         $res = TRUE;
00763                 } 
00764                 elseif ( $this-&gt;hasST() ) {
00765                         <span class="comment">// if a Service Ticket was given, validate it</span>
00766                         <a class="code" href="group__internalDebug.html#ga3">phpCAS::trace</a>('ST `'.$this-&gt;getST().<span class="charliteral">'\'</span> is present');
00767                         $this-&gt;<a class="code" href="group__internalBasic.html#ga10">validateST</a>($validate_url,$text_response,$tree_response); <span class="comment">// if it fails, it halts</span>
00768                         <a class="code" href="group__internalDebug.html#ga3">phpCAS::trace</a>('ST `'.$this-&gt;getST().<span class="charliteral">'\'</span> was validated');
00769                         <span class="keywordflow">if</span> ( $this-&gt;<a class="code" href="group__internalProxy.html#ga2">isProxy</a>() ) {
00770                                 $this-&gt;<a class="code" href="group__internalPGTStorage.html#ga8">validatePGT</a>($validate_url,$text_response,$tree_response); <span class="comment">// idem</span>
00771                                 <a class="code" href="group__internalDebug.html#ga3">phpCAS::trace</a>('PGT `'.$this-&gt;getPGT().<span class="charliteral">'\'</span> was validated');
00772                                 $_SESSION['<a class="code" href="classphpCAS.html">phpCAS</a>']['pgt'] = $this-&gt;<a class="code" href="group__internalProxy.html#ga3">getPGT</a>();
00773                         }
00774                         $_SESSION['<a class="code" href="classphpCAS.html">phpCAS</a>']['user'] = $this-&gt;<a class="code" href="group__internalAuthentication.html#ga3">getUser</a>();
00775                         $res = TRUE;
00776                 }
00777                 elseif ( $this-&gt;hasPT() ) {
00778                         <span class="comment">// if a Proxy Ticket was given, validate it</span>
00779                         <a class="code" href="group__internalDebug.html#ga3">phpCAS::trace</a>('PT `'.$this-&gt;getPT().<span class="charliteral">'\'</span> is present');
00780                         $this-&gt;<a class="code" href="group__internalProxied.html#ga4">validatePT</a>($validate_url,$text_response,$tree_response); <span class="comment">// note: if it fails, it halts</span>
00781                         <a class="code" href="group__internalDebug.html#ga3">phpCAS::trace</a>('PT `'.$this-&gt;getPT().<span class="charliteral">'\'</span> was validated');
00782                         <span class="keywordflow">if</span> ( $this-&gt;<a class="code" href="group__internalProxy.html#ga2">isProxy</a>() ) {
00783                                 $this-&gt;<a class="code" href="group__internalPGTStorage.html#ga8">validatePGT</a>($validate_url,$text_response,$tree_response); <span class="comment">// idem</span>
00784                                 <a class="code" href="group__internalDebug.html#ga3">phpCAS::trace</a>('PGT `'.$this-&gt;getPGT().<span class="charliteral">'\'</span> was validated');
00785                                 $_SESSION['<a class="code" href="classphpCAS.html">phpCAS</a>']['pgt'] = $this-&gt;<a class="code" href="group__internalProxy.html#ga3">getPGT</a>();
00786                         }
00787                         $_SESSION['<a class="code" href="classphpCAS.html">phpCAS</a>']['user'] = $this-&gt;<a class="code" href="group__internalAuthentication.html#ga3">getUser</a>();
00788                         $res = TRUE;
00789                 } 
00790                 <span class="keywordflow">else</span> {
00791                         <span class="comment">// no ticket given, not authenticated</span>
00792                         <a class="code" href="group__internalDebug.html#ga3">phpCAS::trace</a>('no ticket found');
00793                 }
00794                 
00795                 <a class="code" href="group__internalDebug.html#ga5">phpCAS::traceEnd</a>($res);
00796                 <span class="keywordflow">return</span> $res;
00797                 }
00798         
<a name="l00804"></a><a class="code" href="group__internalAuthentication.html#ga9">00804</a>         function <a class="code" href="group__internalAuthentication.html#ga9">isSessionAuthenticated</a> ()
00805                 {
00806                 <span class="keywordflow">return</span> !empty($_SESSION['<a class="code" href="classphpCAS.html">phpCAS</a>']['user']);
00807                 }
00808         
<a name="l00819"></a><a class="code" href="group__internalAuthentication.html#ga10">00819</a>         function <a class="code" href="group__internalAuthentication.html#ga10">wasPreviouslyAuthenticated</a>()
00820                 {
00821                 <a class="code" href="group__internalDebug.html#ga4">phpCAS::traceBegin</a>();
00822                 
00823                 <span class="keywordflow">if</span> ( $this-&gt;<a class="code" href="group__internalCallback.html#ga3">isCallbackMode</a>() ) {
00824                         $this-&gt;<a class="code" href="group__internalCallback.html#ga6">callback</a>();
00825                 }
00826                 
00827                 $auth = FALSE;
00828                 
00829                 <span class="keywordflow">if</span> ( $this-&gt;<a class="code" href="group__internalProxy.html#ga2">isProxy</a>() ) {
00830                         <span class="comment">// CAS proxy: username and PGT must be present</span>
00831                         <span class="keywordflow">if</span> ( $this-&gt;<a class="code" href="group__internalAuthentication.html#ga9">isSessionAuthenticated</a>() &amp;&amp; !empty($_SESSION['<a class="code" href="classphpCAS.html">phpCAS</a>']['pgt']) ) {
00832                                 <span class="comment">// authentication already done</span>
00833                                 $this-&gt;<a class="code" href="group__internalAuthentication.html#ga2">setUser</a>($_SESSION['<a class="code" href="classphpCAS.html">phpCAS</a>']['user']);
00834                                 $this-&gt;<a class="code" href="group__internalProxy.html#ga4">setPGT</a>($_SESSION['<a class="code" href="classphpCAS.html">phpCAS</a>']['pgt']);
00835                                 <a class="code" href="group__internalDebug.html#ga3">phpCAS::trace</a>('user = `'.$_SESSION['<a class="code" href="classphpCAS.html">phpCAS</a>']['user'].<span class="charliteral">'\'</span>, PGT = `'.$_SESSION['<a class="code" href="classphpCAS.html">phpCAS</a>']['pgt'].<span class="charliteral">'\''</span>); 
00836                                 $auth = TRUE;
00837                         } elseif ( $this-&gt;isSessionAuthenticated() &amp;&amp; empty($_SESSION['<a class="code" href="classphpCAS.html">phpCAS</a>']['pgt']) ) {
00838                                 <span class="comment">// these two variables should be empty or not empty at the same time</span>
00839                                 <a class="code" href="group__internalDebug.html#ga3">phpCAS::trace</a>('username found (`'.$_SESSION['<a class="code" href="classphpCAS.html">phpCAS</a>']['user'].<span class="charliteral">'\'</span>) but PGT is empty');
00840                                 <span class="comment">// unset all tickets to enforce authentication</span>
00841                                 unset($_SESSION['<a class="code" href="classphpCAS.html">phpCAS</a>']);
00842                                 $this-&gt;<a class="code" href="group__internalBasic.html#ga5">setST</a>('');
00843                                 $this-&gt;<a class="code" href="group__internalProxied.html#ga2">setPT</a>('');
00844                         } elseif ( !$this-&gt;isSessionAuthenticated() &amp;&amp; !empty($_SESSION['<a class="code" href="classphpCAS.html">phpCAS</a>']['pgt']) ) {
00845                                 <span class="comment">// these two variables should be empty or not empty at the same time</span>
00846                                 <a class="code" href="group__internalDebug.html#ga3">phpCAS::trace</a>('PGT found (`'.$_SESSION['<a class="code" href="classphpCAS.html">phpCAS</a>']['pgt'].<span class="charliteral">'\'</span>) but username is empty'); 
00847                                 <span class="comment">// unset all tickets to enforce authentication</span>
00848                                 unset($_SESSION['<a class="code" href="classphpCAS.html">phpCAS</a>']);
00849                                 $this-&gt;<a class="code" href="group__internalBasic.html#ga5">setST</a>('');
00850                                 $this-&gt;<a class="code" href="group__internalProxied.html#ga2">setPT</a>('');
00851                         } <span class="keywordflow">else</span> {
00852                                 <a class="code" href="group__internalDebug.html#ga3">phpCAS::trace</a>('neither user not PGT found'); 
00853                         }
00854                 } <span class="keywordflow">else</span> {
00855                         <span class="comment">// `simple' CAS client (not a proxy): username must be present</span>
00856                         <span class="keywordflow">if</span> ( $this-&gt;<a class="code" href="group__internalAuthentication.html#ga9">isSessionAuthenticated</a>() ) {
00857                                 <span class="comment">// authentication already done</span>
00858                                 $this-&gt;<a class="code" href="group__internalAuthentication.html#ga2">setUser</a>($_SESSION['<a class="code" href="classphpCAS.html">phpCAS</a>']['user']);
00859                                 <a class="code" href="group__internalDebug.html#ga3">phpCAS::trace</a>('user = `'.$_SESSION['<a class="code" href="classphpCAS.html">phpCAS</a>']['user'].<span class="charliteral">'\''</span>); 
00860                                 $auth = TRUE;
00861                         } <span class="keywordflow">else</span> {
00862                                 <a class="code" href="group__internalDebug.html#ga3">phpCAS::trace</a>('no user found');
00863                         }
00864                 }
00865                 
00866                 <a class="code" href="group__internalDebug.html#ga5">phpCAS::traceEnd</a>($auth);
00867                 <span class="keywordflow">return</span> $auth;
00868                 }
00869         
<a name="l00877"></a><a class="code" href="group__internalAuthentication.html#ga11">00877</a>         function <a class="code" href="group__internalAuthentication.html#ga11">redirectToCas</a>($gateway=<span class="keyword">false</span>,$renew=<span class="keyword">false</span>){
00878                 <a class="code" href="group__internalDebug.html#ga4">phpCAS::traceBegin</a>();
00879                 $cas_url = $this-&gt;<a class="code" href="group__internalConfig.html#ga6">getServerLoginURL</a>($gateway,$renew);
00880                 header('Location: '.$cas_url);
00881                 <a class="code" href="group__internalDebug.html#ga1">phpCAS::log</a>( <span class="stringliteral">"Redirect to : "</span>.$cas_url );
00882                 
00883                 $this-&gt;<a class="code" href="group__internalOutput.html#ga3">printHTMLHeader</a>($this-&gt;getString(<a class="code" href="languages_8php.html#a1">CAS_STR_AUTHENTICATION_WANTED</a>));
00884                 
00885                 printf('&lt;p&gt;'.$this-&gt;getString(<a class="code" href="languages_8php.html#a3">CAS_STR_SHOULD_HAVE_BEEN_REDIRECTED</a>).'&lt;/p&gt;',$cas_url);
00886                 $this-&gt;<a class="code" href="group__internalOutput.html#ga4">printHTMLFooter</a>();
00887                 <a class="code" href="group__internalDebug.html#ga6">phpCAS::traceExit</a>();
00888                 exit();
00889         }
00890 
<a name="l00896"></a><a class="code" href="group__internalAuthentication.html#ga12">00896</a>         function <a class="code" href="group__internalAuthentication.html#ga12">logout</a>($url = <span class="stringliteral">""</span>)
00897                 {
00898                 <a class="code" href="group__internalDebug.html#ga4">phpCAS::traceBegin</a>();
00899                 $cas_url = $this-&gt;<a class="code" href="group__internalConfig.html#ga11">getServerLogoutURL</a>();
00900                 <span class="comment">// v0.4.14 sebastien.gougeon at univ-rennes1.fr</span>
00901                 <span class="comment">// header('Location: '.$cas_url);</span>
00902                 <span class="keywordflow">if</span> ( $url != <span class="stringliteral">""</span> ) {
00903                         $url = '?service=' . $url;
00904                 }
00905                 header('Location: '.$cas_url . $url);
00906                 session_unset();
00907                 session_destroy();
00908                 $this-&gt;<a class="code" href="group__internalOutput.html#ga3">printHTMLHeader</a>($this-&gt;getString(<a class="code" href="languages_8php.html#a2">CAS_STR_LOGOUT</a>));
00909                 printf('&lt;p&gt;'.$this-&gt;getString(<a class="code" href="languages_8php.html#a3">CAS_STR_SHOULD_HAVE_BEEN_REDIRECTED</a>).'&lt;/p&gt;',$cas_url);
00910                 $this-&gt;<a class="code" href="group__internalOutput.html#ga4">printHTMLFooter</a>();
00911                 <a class="code" href="group__internalDebug.html#ga6">phpCAS::traceExit</a>();
00912                 exit();
00913                 }
00914         
00917         <span class="comment">// XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX</span>
00918         <span class="comment">// XX                                                                    XX</span>
00919         <span class="comment">// XX                  BASIC CLIENT FEATURES (CAS 1.0)                   XX</span>
00920         <span class="comment">// XX                                                                    XX</span>
00921         <span class="comment">// XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX</span>
00922         
00923         <span class="comment">// ########################################################################</span>
00924         <span class="comment">//  ST</span>
00925         <span class="comment">// ########################################################################</span>
<a name="l00939"></a><a class="code" href="group__internalBasic.html#ga0">00939</a> <span class="comment"></span>        var <a class="code" href="group__internalBasic.html#ga0">$_st</a> = '';
00940         
<a name="l00946"></a><a class="code" href="group__internalBasic.html#ga4">00946</a>         function <a class="code" href="group__internalBasic.html#ga4">getST</a>()
00947                 { <span class="keywordflow">return</span> $this-&gt;_st; }
00948         
<a name="l00954"></a><a class="code" href="group__internalBasic.html#ga5">00954</a>         function <a class="code" href="group__internalBasic.html#ga5">setST</a>($st)
00955                 { $this-&gt;_st = $st; }
00956         
<a name="l00962"></a><a class="code" href="group__internalBasic.html#ga6">00962</a>         function <a class="code" href="group__internalBasic.html#ga6">hasST</a>()
00963                 { <span class="keywordflow">return</span> !empty($this-&gt;_st); }
00964         
00967         <span class="comment">// ########################################################################</span>
00968         <span class="comment">//  ST VALIDATION</span>
00969         <span class="comment">// ########################################################################</span>
<a name="l00981"></a><a class="code" href="group__internalBasic.html#ga1">00981</a> <span class="comment"></span>        var <a class="code" href="group__internalBasic.html#ga1">$_cas_server_cert</a> = '';
00982         
<a name="l00989"></a><a class="code" href="group__internalBasic.html#ga2">00989</a>         var <a class="code" href="group__internalBasic.html#ga2">$_cas_server_ca_cert</a> = '';
00990         
<a name="l00997"></a><a class="code" href="group__internalBasic.html#ga3">00997</a>         var <a class="code" href="group__internalBasic.html#ga3">$_no_cas_server_validation</a> = <span class="keyword">false</span>;
00998         
<a name="l01004"></a><a class="code" href="group__internalBasic.html#ga7">01004</a>         function <a class="code" href="group__internalBasic.html#ga7">setCasServerCert</a>($cert)
01005                 {
01006                 $this-&gt;_cas_server_cert = $cert;
01007                 }
01008         
<a name="l01014"></a><a class="code" href="group__internalBasic.html#ga8">01014</a>         function <a class="code" href="group__internalBasic.html#ga8">setCasServerCACert</a>($cert)
01015                 {
01016                 $this-&gt;_cas_server_ca_cert = $cert;
01017                 }
01018         
<a name="l01022"></a><a class="code" href="group__internalBasic.html#ga9">01022</a>         function <a class="code" href="group__internalBasic.html#ga9">setNoCasServerValidation</a>()
01023                 {
01024                 $this-&gt;_no_cas_server_validation = <span class="keyword">true</span>;
01025                 }
01026         
<a name="l01040"></a><a class="code" href="group__internalBasic.html#ga10">01040</a>         function <a class="code" href="group__internalBasic.html#ga10">validateST</a>($validate_url,&amp;$text_response,&amp;$tree_response)
01041                 {
01042                 <a class="code" href="group__internalDebug.html#ga4">phpCAS::traceBegin</a>();
01043                 <span class="comment">// build the URL to validate the ticket</span>
01044                 $validate_url = $this-&gt;<a class="code" href="group__internalConfig.html#ga8">getServerServiceValidateURL</a>().'&amp;ticket='.$this-&gt;getST();
01045                 <span class="keywordflow">if</span> ( $this-&gt;<a class="code" href="group__internalProxy.html#ga2">isProxy</a>() ) {
01046                         <span class="comment">// pass the callback url for CAS proxies</span>
01047                         $validate_url .= '&amp;pgtUrl='.$this-&gt;getCallbackURL();
01048                 }
01049                 
01050                 <span class="comment">// open and read the URL</span>
01051                 <span class="keywordflow">if</span> ( !$this-&gt;<a class="code" href="group__internalPGTStorage.html#ga10">readURL</a>($validate_url,''<span class="comment">/*cookies*/</span>,$headers,$text_response,$err_msg) ) {
01052                         <a class="code" href="group__internalDebug.html#ga3">phpCAS::trace</a>('could not open URL \''.$validate_url.<span class="charliteral">'\'</span> to validate ('.$err_msg.<span class="charliteral">')'</span>);
01053                         $this-&gt;authError('ST not validated',
01054                                 $validate_url,
01055                                 TRUE<span class="comment">/*$no_response*/</span>);
01056                 }
01057                 
01058                 <span class="comment">// analyze the result depending on the version</span>
01059                 <span class="keywordflow">switch</span> ($this-&gt;<a class="code" href="group__internalConfig.html#ga1">getServerVersion</a>()) {
01060                         <span class="keywordflow">case</span> <a class="code" href="group__public.html#ga1">CAS_VERSION_1_0</a>:
01061                                 <span class="keywordflow">if</span> (preg_match('/^no\n/',$text_response)) {
01062                                         <a class="code" href="group__internalDebug.html#ga3">phpCAS::trace</a>('ST has not been validated');
01063                                         $this-&gt;<a class="code" href="group__internalMisc.html#ga4">authError</a>('ST not validated',
01064                                                 $validate_url,
01065                                                 FALSE<span class="comment">/*$no_response*/</span>,
01066                                                 FALSE<span class="comment">/*$bad_response*/</span>,
01067                                                 $text_response);
01068                                 }
01069                                 <span class="keywordflow">if</span> (!preg_match('/^yes\n/',$text_response)) {
01070                                         <a class="code" href="group__internalDebug.html#ga3">phpCAS::trace</a>('ill-formed response');
01071                                         $this-&gt;<a class="code" href="group__internalMisc.html#ga4">authError</a>('ST not validated',
01072                                                 $validate_url,
01073                                                 FALSE<span class="comment">/*$no_response*/</span>,
01074                                                 TRUE<span class="comment">/*$bad_response*/</span>,
01075                                                 $text_response);
01076                                 }
01077                                 <span class="comment">// ST has been validated, extract the user name</span>
01078                                 $arr = preg_split('/\n/',$text_response);
01079                                 $this-&gt;<a class="code" href="group__internalAuthentication.html#ga2">setUser</a>(trim($arr[1]));
01080                                 <span class="keywordflow">break</span>;
01081                         <span class="keywordflow">case</span> <a class="code" href="group__public.html#ga2">CAS_VERSION_2_0</a>:
01082                                 <span class="comment">// read the response of the CAS server into a DOM object</span>
01083                                 <span class="keywordflow">if</span> ( !($dom = <a class="code" href="domxml-php4-php5_8php.html#a2">domxml_open_mem</a>($text_response))) {
01084                                         <a class="code" href="group__internalDebug.html#ga3">phpCAS::trace</a>('<a class="code" href="domxml-php4-php5_8php.html#a2">domxml_open_mem</a>() failed');
01085                                         $this-&gt;<a class="code" href="group__internalMisc.html#ga4">authError</a>('ST not validated',
01086                                                 $validate_url,
01087                                                 FALSE<span class="comment">/*$no_response*/</span>,
01088                                                 TRUE<span class="comment">/*$bad_response*/</span>,
01089                                                 $text_response);
01090                                 }
01091                                 <span class="comment">// read the root node of the XML tree</span>
01092                                 <span class="keywordflow">if</span> ( !($tree_response = $dom-&gt;document_element()) ) {
01093                                         <a class="code" href="group__internalDebug.html#ga3">phpCAS::trace</a>('document_element() failed');
01094                                         $this-&gt;<a class="code" href="group__internalMisc.html#ga4">authError</a>('ST not validated',
01095                                                 $validate_url,
01096                                                 FALSE<span class="comment">/*$no_response*/</span>,
01097                                                 TRUE<span class="comment">/*$bad_response*/</span>,
01098                                                 $text_response);
01099                                 }
01100                                 <span class="comment">// insure that tag name is 'serviceResponse'</span>
01101                                 <span class="keywordflow">if</span> ( $tree_response-&gt;node_name() != 'serviceResponse' ) {
01102                                         <a class="code" href="group__internalDebug.html#ga3">phpCAS::trace</a>('bad XML root node (should be `serviceResponse\' instead of `'.$tree_response-&gt;node_name().<span class="charliteral">'\''</span>);
01103                                         $this-&gt;<a class="code" href="group__internalMisc.html#ga4">authError</a>('ST not validated',
01104                                                 $validate_url,
01105                                                 FALSE<span class="comment">/*$no_response*/</span>,
01106                                                 TRUE<span class="comment">/*$bad_response*/</span>,
01107                                                 $text_response);
01108                                 }
01109                                 <span class="keywordflow">if</span> ( <span class="keyword">sizeof</span>($success_elements = $tree_response-&gt;get_elements_by_tagname(<span class="stringliteral">"authenticationSuccess"</span>)) != 0) {
01110                                         <span class="comment">// authentication succeded, extract the user name</span>
01111                                         <span class="keywordflow">if</span> ( <span class="keyword">sizeof</span>($user_elements = $success_elements[0]-&gt;get_elements_by_tagname(<span class="stringliteral">"user"</span>)) == 0) {
01112                                                 <a class="code" href="group__internalDebug.html#ga3">phpCAS::trace</a>('&lt;authenticationSuccess&gt; found, but no &lt;user&gt;');
01113                                                 $this-&gt;<a class="code" href="group__internalMisc.html#ga4">authError</a>('ST not validated',
01114                                                         $validate_url,
01115                                                         FALSE<span class="comment">/*$no_response*/</span>,
01116                                                         TRUE<span class="comment">/*$bad_response*/</span>,
01117                                                         $text_response);
01118                                         }
01119                                         $user = trim($user_elements[0]-&gt;get_content());
01120                                         <a class="code" href="group__internalDebug.html#ga3">phpCAS::trace</a>('user = `'.$user);
01121                                         $this-&gt;<a class="code" href="group__internalAuthentication.html#ga2">setUser</a>($user);
01122                                         
01123                                 } <span class="keywordflow">else</span> <span class="keywordflow">if</span> ( <span class="keyword">sizeof</span>($failure_elements = $tree_response-&gt;get_elements_by_tagname(<span class="stringliteral">"authenticationFailure"</span>)) != 0) {
01124                                         <a class="code" href="group__internalDebug.html#ga3">phpCAS::trace</a>('&lt;authenticationFailure&gt; found');
01125                                         <span class="comment">// authentication failed, extract the error code and message</span>
01126                                         $this-&gt;<a class="code" href="group__internalMisc.html#ga4">authError</a>('ST not validated',
01127                                                 $validate_url,
01128                                                 FALSE<span class="comment">/*$no_response*/</span>,
01129                                                 FALSE<span class="comment">/*$bad_response*/</span>,
01130                                                 $text_response,
01131                                                 $failure_elements[0]-&gt;get_attribute('code')<span class="comment">/*$err_code*/</span>,
01132                                                 trim($failure_elements[0]-&gt;get_content())<span class="comment">/*$err_msg*/</span>);
01133                                 } <span class="keywordflow">else</span> {
01134                                         <a class="code" href="group__internalDebug.html#ga3">phpCAS::trace</a>('neither &lt;authenticationSuccess&gt; nor &lt;authenticationFailure&gt; found');
01135                                         $this-&gt;<a class="code" href="group__internalMisc.html#ga4">authError</a>('ST not validated',
01136                                                 $validate_url,
01137                                                 FALSE<span class="comment">/*$no_response*/</span>,
01138                                                 TRUE<span class="comment">/*$bad_response*/</span>,
01139                                                 $text_response);
01140                                 }
01141                                 <span class="keywordflow">break</span>;
01142                 }
01143                 
01144                 <span class="comment">// at this step, ST has been validated and $this-&gt;_user has been set,</span>
01145                 <a class="code" href="group__internalDebug.html#ga5">phpCAS::traceEnd</a>(TRUE);
01146                 <span class="keywordflow">return</span> TRUE;
01147                 }
01148         
01151         <span class="comment">// XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX</span>
01152         <span class="comment">// XX                                                                    XX</span>
01153         <span class="comment">// XX                     PROXY FEATURES (CAS 2.0)                       XX</span>
01154         <span class="comment">// XX                                                                    XX</span>
01155         <span class="comment">// XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX</span>
01156         
01157         <span class="comment">// ########################################################################</span>
01158         <span class="comment">//  PROXYING</span>
01159         <span class="comment">// ########################################################################</span>
<a name="l01171"></a><a class="code" href="group__internalProxy.html#ga0">01171</a> <span class="comment"></span>        var <a class="code" href="group__internalProxy.html#ga0">$_proxy</a>;
01172         
<a name="l01180"></a><a class="code" href="group__internalProxy.html#ga2">01180</a>         function <a class="code" href="group__internalProxy.html#ga2">isProxy</a>()
01181                 {
01182                 <span class="keywordflow">return</span> $this-&gt;_proxy;
01183                 }
01184         
01186         <span class="comment">// ########################################################################</span>
01187         <span class="comment">//  PGT</span>
01188         <span class="comment">// ########################################################################</span>
<a name="l01201"></a><a class="code" href="group__internalProxy.html#ga1">01201</a> <span class="comment"></span>        var <a class="code" href="group__internalProxy.html#ga1">$_pgt</a> = '';
01202         
<a name="l01208"></a><a class="code" href="group__internalProxy.html#ga3">01208</a>         function <a class="code" href="group__internalProxy.html#ga3">getPGT</a>()
01209                 { <span class="keywordflow">return</span> $this-&gt;_pgt; }
01210         
<a name="l01216"></a><a class="code" href="group__internalProxy.html#ga4">01216</a>         function <a class="code" href="group__internalProxy.html#ga4">setPGT</a>($pgt)
01217                 { $this-&gt;_pgt = $pgt; }
01218         
<a name="l01224"></a><a class="code" href="group__internalProxy.html#ga5">01224</a>         function <a class="code" href="group__internalProxy.html#ga5">hasPGT</a>()
01225                 { <span class="keywordflow">return</span> !empty($this-&gt;_pgt); }
01226         
01229         <span class="comment">// ########################################################################</span>
01230         <span class="comment">//  CALLBACK MODE</span>
01231         <span class="comment">// ########################################################################</span>
<a name="l01249"></a><a class="code" href="group__internalCallback.html#ga0">01249</a> <span class="comment"></span>        var <a class="code" href="group__internalCallback.html#ga0">$_callback_mode</a> = FALSE;
01250         
<a name="l01258"></a><a class="code" href="group__internalCallback.html#ga2">01258</a>         function <a class="code" href="group__internalCallback.html#ga2">setCallbackMode</a>($callback_mode)
01259                 {
01260                 $this-&gt;_callback_mode = $callback_mode;
01261                 }
01262         
<a name="l01271"></a><a class="code" href="group__internalCallback.html#ga3">01271</a>         function <a class="code" href="group__internalCallback.html#ga3">isCallbackMode</a>()
01272                 {
01273                 <span class="keywordflow">return</span> $this-&gt;_callback_mode;
01274                 }
01275         
<a name="l01284"></a><a class="code" href="group__internalCallback.html#ga1">01284</a>         var <a class="code" href="group__internalCallback.html#ga1">$_callback_url</a> = '';
01285         
<a name="l01295"></a><a class="code" href="group__internalCallback.html#ga4">01295</a>         function <a class="code" href="group__internalCallback.html#ga4">getCallbackURL</a>()
01296                 {
01297                 <span class="comment">// the URL is built when needed only</span>
01298                 <span class="keywordflow">if</span> ( empty($this-&gt;_callback_url) ) {
01299                         $final_uri = '';
01300                         <span class="comment">// remove the ticket if present in the URL</span>
01301                         $final_uri = 'https:<span class="comment">//';</span>
01302                         <span class="comment">/* replaced by Julien Marchal - v0.4.6</span>
01303 <span class="comment">                         * $this-&gt;uri .= $_SERVER['SERVER_NAME'];</span>
01304 <span class="comment">                         */</span>
01305                         <span class="keywordflow">if</span>(empty($_SERVER['HTTP_X_FORWARDED_SERVER'])){
01306                                 <span class="comment">/* replaced by teedog - v0.4.12</span>
01307 <span class="comment">                                 * $final_uri .= $_SERVER['SERVER_NAME'];</span>
01308 <span class="comment">                                 */</span>
01309                                 <span class="keywordflow">if</span> (empty($_SERVER['SERVER_NAME'])) {
01310                                         $final_uri .= $_SERVER['HTTP_HOST'];
01311                                 } <span class="keywordflow">else</span> {
01312                                         $final_uri .= $_SERVER['SERVER_NAME'];
01313                                 }
01314                         } <span class="keywordflow">else</span> {
01315                                 $final_uri .= $_SERVER['HTTP_X_FORWARDED_SERVER'];
01316                         }
01317                         <span class="keywordflow">if</span> ( ($this-&gt;<a class="code" href="group__internalConfig.html#ga13">isHttps</a>() &amp;&amp; $_SERVER['SERVER_PORT']!=443)
01318                                         || (!$this-&gt;<a class="code" href="group__internalConfig.html#ga13">isHttps</a>() &amp;&amp; $_SERVER['SERVER_PORT']!=80) ) {
01319                                 $final_uri .= <span class="charliteral">':'</span>;
01320                                 $final_uri .= $_SERVER['SERVER_PORT'];
01321                         }
01322                         $request_uri = $_SERVER['REQUEST_URI'];
01323                         $request_uri = preg_replace('/\?.*$/<span class="charliteral">','</span>',$request_uri);
01324                         $final_uri .= $request_uri;
01325                         $this-&gt;<a class="code" href="group__internalCallback.html#ga5">setCallbackURL</a>($final_uri);
01326                 }
01327                 <span class="keywordflow">return</span> $this-&gt;_callback_url;
01328                 }
01329         
<a name="l01337"></a><a class="code" href="group__internalCallback.html#ga5">01337</a>         function <a class="code" href="group__internalCallback.html#ga5">setCallbackURL</a>($url)
01338                 {
01339                 <span class="keywordflow">return</span> $this-&gt;_callback_url = $url;
01340                 }
01341         
<a name="l01348"></a><a class="code" href="group__internalCallback.html#ga6">01348</a>         function <a class="code" href="group__internalCallback.html#ga6">callback</a>()
01349                 {
01350                 <a class="code" href="group__internalDebug.html#ga4">phpCAS::traceBegin</a>();
01351                 $this-&gt;<a class="code" href="group__internalOutput.html#ga3">printHTMLHeader</a>('<a class="code" href="classphpCAS.html">phpCAS</a> callback');
01352                 $pgt_iou = $_GET['pgtIou'];
01353                 $pgt = $_GET['pgtId'];
01354                 <a class="code" href="group__internalDebug.html#ga3">phpCAS::trace</a>('Storing PGT `'.$pgt.<span class="charliteral">'\'</span> (<span class="keywordtype">id</span>=`'.$pgt_iou.<span class="charliteral">'\'</span>)');
01355                 echo '&lt;p&gt;Storing PGT `'.$pgt.<span class="charliteral">'\'</span> (<span class="keywordtype">id</span>=`'.$pgt_iou.<span class="charliteral">'\'</span>).&lt;/p&gt;';
01356                 $this-&gt;storePGT($pgt,$pgt_iou);
01357                 $this-&gt;<a class="code" href="group__internalOutput.html#ga4">printHTMLFooter</a>();
01358                 <a class="code" href="group__internalDebug.html#ga6">phpCAS::traceExit</a>();
01359                 }
01360         
01363         <span class="comment">// ########################################################################</span>
01364         <span class="comment">//  PGT STORAGE</span>
01365         <span class="comment">// ########################################################################</span>
<a name="l01379"></a><a class="code" href="group__internalPGTStorage.html#ga0">01379</a> <span class="comment"></span>        var <a class="code" href="group__internalPGTStorage.html#ga0">$_pgt_storage</a> = null;
01380         
<a name="l01387"></a><a class="code" href="group__internalPGTStorage.html#ga3">01387</a>         function <a class="code" href="group__internalPGTStorage.html#ga3">initPGTStorage</a>()
01388                 {
01389                 <span class="comment">// if no SetPGTStorageXxx() has been used, default to file</span>
01390                 <span class="keywordflow">if</span> ( !is_object($this-&gt;_pgt_storage) ) {
01391                         $this-&gt;<a class="code" href="group__internalPGTStorage.html#ga6">setPGTStorageFile</a>();
01392                 }
01393                 
01394                 <span class="comment">// initializes the storage</span>
01395                 $this-&gt;_pgt_storage-&gt;init();
01396                 }
01397         
<a name="l01406"></a><a class="code" href="group__internalPGTStorage.html#ga4">01406</a>         function <a class="code" href="group__internalPGTStorage.html#ga4">storePGT</a>($pgt,$pgt_iou)
01407                 {
01408                 <span class="comment">// ensure that storage is initialized</span>
01409                 $this-&gt;<a class="code" href="group__internalPGTStorage.html#ga3">initPGTStorage</a>();
01410                 <span class="comment">// writes the PGT</span>
01411                 $this-&gt;_pgt_storage-&gt;write($pgt,$pgt_iou);
01412                 }
01413         
<a name="l01423"></a><a class="code" href="group__internalPGTStorage.html#ga5">01423</a>         function <a class="code" href="group__internalPGTStorage.html#ga5">loadPGT</a>($pgt_iou)
01424                 {
01425                 <span class="comment">// ensure that storage is initialized</span>
01426                 $this-&gt;<a class="code" href="group__internalPGTStorage.html#ga3">initPGTStorage</a>();
01427                 <span class="comment">// read the PGT</span>
01428                 <span class="keywordflow">return</span> $this-&gt;_pgt_storage-&gt;read($pgt_iou);
01429                 }
01430         
<a name="l01440"></a><a class="code" href="group__internalPGTStorage.html#ga6">01440</a>         function <a class="code" href="group__internalPGTStorage.html#ga6">setPGTStorageFile</a>($format='',
01441                 $path='')
01442                 {
01443                 <span class="comment">// check that the storage has not already been set</span>
01444                 <span class="keywordflow">if</span> ( is_object($this-&gt;_pgt_storage) ) {
01445                         <a class="code" href="group__internalDebug.html#ga2">phpCAS::error</a>('PGT storage already defined');
01446                 }
01447                 
01448                 <span class="comment">// create the storage object</span>
01449                 $this-&gt;_pgt_storage = &amp;<span class="keyword">new</span> <a class="code" href="classPGTStorageFile.html">PGTStorageFile</a>($<span class="keyword">this</span>,$format,$path);
01450                 }
01451         
<a name="l01469"></a><a class="code" href="group__internalPGTStorage.html#ga7">01469</a>         function <a class="code" href="group__internalPGTStorage.html#ga7">setPGTStorageDB</a>($user,
01470                                                          $password,
01471                                                          $database_type,
01472                                                          $hostname,
01473                                                          $port,
01474                                                          $database,
01475                                                          $table)
01476                 {
01477                 <span class="comment">// check that the storage has not already been set</span>
01478                 <span class="keywordflow">if</span> ( is_object($this-&gt;_pgt_storage) ) {
01479                         <a class="code" href="group__internalDebug.html#ga2">phpCAS::error</a>('PGT storage already defined');
01480                 }
01481                 
01482                 <span class="comment">// warn the user that he should use file storage...</span>
01483                 trigger_error('PGT storage into database is an experimental feature, use at your own risk',E_USER_WARNING);
01484                 
01485                 <span class="comment">// create the storage object</span>
01486                 $this-&gt;_pgt_storage = &amp; <span class="keyword">new</span> <a class="code" href="classPGTStorageDB.html">PGTStorageDB</a>($<span class="keyword">this</span>,$user,$password,$database_type,$hostname,$port,$database,$table);
01487                 }
01488         
01489         <span class="comment">// ########################################################################</span>
01490         <span class="comment">//  PGT VALIDATION</span>
01491         <span class="comment">// ########################################################################</span>
<a name="l01505"></a><a class="code" href="group__internalPGTStorage.html#ga8">01505</a> <span class="comment"></span>        function <a class="code" href="group__internalPGTStorage.html#ga8">validatePGT</a>(&amp;$validate_url,$text_response,$tree_response)
01506                 {
01507                 <a class="code" href="group__internalDebug.html#ga4">phpCAS::traceBegin</a>();
01508                 <span class="keywordflow">if</span> ( <span class="keyword">sizeof</span>($arr = $tree_response-&gt;get_elements_by_tagname(<span class="stringliteral">"proxyGrantingTicket"</span>)) == 0) {
01509                         <a class="code" href="group__internalDebug.html#ga3">phpCAS::trace</a>('&lt;proxyGrantingTicket&gt; not found');
01510                         <span class="comment">// authentication succeded, but no PGT Iou was transmitted</span>
01511                         $this-&gt;<a class="code" href="group__internalMisc.html#ga4">authError</a>('Ticket validated but no PGT Iou transmitted',
01512                                 $validate_url,
01513                                 FALSE<span class="comment">/*$no_response*/</span>,
01514                                 FALSE<span class="comment">/*$bad_response*/</span>,
01515                                 $text_response);
01516                 } <span class="keywordflow">else</span> {
01517                         <span class="comment">// PGT Iou transmitted, extract it</span>
01518                         $pgt_iou = trim($arr[0]-&gt;get_content());
01519                         $pgt = $this-&gt;<a class="code" href="group__internalPGTStorage.html#ga5">loadPGT</a>($pgt_iou);
01520                         <span class="keywordflow">if</span> ( $pgt == FALSE ) {
01521                                 <a class="code" href="group__internalDebug.html#ga3">phpCAS::trace</a>('could not load PGT');
01522                                 $this-&gt;<a class="code" href="group__internalMisc.html#ga4">authError</a>('PGT Iou was transmitted but PGT could not be retrieved',
01523                                         $validate_url,
01524                                         FALSE<span class="comment">/*$no_response*/</span>,
01525                                         FALSE<span class="comment">/*$bad_response*/</span>,
01526                                         $text_response);
01527                         }
01528                         $this-&gt;<a class="code" href="group__internalProxy.html#ga4">setPGT</a>($pgt);
01529                 }
01530                 <a class="code" href="group__internalDebug.html#ga5">phpCAS::traceEnd</a>(TRUE);
01531                 <span class="keywordflow">return</span> TRUE;
01532                 }
01533         
01534         <span class="comment">// ########################################################################</span>
01535         <span class="comment">//  PGT VALIDATION</span>
01536         <span class="comment">// ########################################################################</span>
01537         
<a name="l01549"></a><a class="code" href="group__internalPGTStorage.html#ga9">01549</a>         function <a class="code" href="group__internalPGTStorage.html#ga9">retrievePT</a>($target_service,&amp;$err_code,&amp;$err_msg)
01550                 {
01551                 <a class="code" href="group__internalDebug.html#ga4">phpCAS::traceBegin</a>();
01552                 
01553                 <span class="comment">// by default, $err_msg is set empty and $pt to TRUE. On error, $pt is</span>
01554                 <span class="comment">// set to false and $err_msg to an error message. At the end, if $pt is FALSE </span>
01555                 <span class="comment">// and $error_msg is still empty, it is set to 'invalid response' (the most</span>
01556                 <span class="comment">// commonly encountered error).</span>
01557                 $err_msg = '';
01558                 
01559                 <span class="comment">// build the URL to retrieve the PT</span>
01560                 <span class="comment">//      $cas_url = $this-&gt;getServerProxyURL().'?targetService='.preg_replace('/&amp;/','%26',$target_service).'&amp;pgt='.$this-&gt;getPGT();</span>
01561                 $cas_url = $this-&gt;<a class="code" href="group__internalConfig.html#ga10">getServerProxyURL</a>().'?targetService='.urlencode($target_service).'&amp;pgt='.$this-&gt;getPGT();
01562                 
01563                 <span class="comment">// open and read the URL</span>
01564                 <span class="keywordflow">if</span> ( !$this-&gt;<a class="code" href="group__internalPGTStorage.html#ga10">readURL</a>($cas_url,''<span class="comment">/*cookies*/</span>,$headers,$cas_response,$err_msg) ) {
01565                         <a class="code" href="group__internalDebug.html#ga3">phpCAS::trace</a>('could not open URL \''.$cas_url.<span class="charliteral">'\'</span> to validate ('.$err_msg.<span class="charliteral">')'</span>);
01566                         $err_code = <a class="code" href="group__publicServices.html#ga3">PHPCAS_SERVICE_PT_NO_SERVER_RESPONSE</a>;
01567                         $err_msg = 'could not retrieve PT (no response from the CAS server)';
01568                         phpCAS::traceEnd(FALSE);
01569                         <span class="keywordflow">return</span> FALSE;
01570                 }
01571                 
01572                 $bad_response = FALSE;
01573                 
01574                 <span class="keywordflow">if</span> ( !$bad_response ) {
01575                         <span class="comment">// read the response of the CAS server into a DOM object</span>
01576                         <span class="keywordflow">if</span> ( !($dom = @<a class="code" href="domxml-php4-php5_8php.html#a2">domxml_open_mem</a>($cas_response))) {
01577                                 phpCAS::trace('<a class="code" href="domxml-php4-php5_8php.html#a2">domxml_open_mem</a>() failed');
01578                                 <span class="comment">// read failed</span>
01579                                 $bad_response = TRUE;
01580                         } 
01581                 }
01582                 
01583                 <span class="keywordflow">if</span> ( !$bad_response ) {
01584                         <span class="comment">// read the root node of the XML tree</span>
01585                         <span class="keywordflow">if</span> ( !($root = $dom-&gt;document_element()) ) {
01586                                 <a class="code" href="group__internalDebug.html#ga3">phpCAS::trace</a>('document_element() failed');
01587                                 <span class="comment">// read failed</span>
01588                                 $bad_response = TRUE;
01589                         } 
01590                 }
01591                 
01592                 <span class="keywordflow">if</span> ( !$bad_response ) {
01593                         <span class="comment">// insure that tag name is 'serviceResponse'</span>
01594                         <span class="keywordflow">if</span> ( $root-&gt;node_name() != 'serviceResponse' ) {
01595                                 <a class="code" href="group__internalDebug.html#ga3">phpCAS::trace</a>('node_name() failed');
01596                                 <span class="comment">// bad root node</span>
01597                                 $bad_response = TRUE;
01598                         } 
01599                 }
01600                 
01601                 <span class="keywordflow">if</span> ( !$bad_response ) {
01602                         <span class="comment">// look for a proxySuccess tag</span>
01603                         <span class="keywordflow">if</span> ( <span class="keyword">sizeof</span>($arr = $root-&gt;get_elements_by_tagname(<span class="stringliteral">"proxySuccess"</span>)) != 0) {
01604                                 <span class="comment">// authentication succeded, look for a proxyTicket tag</span>
01605                                 <span class="keywordflow">if</span> ( <span class="keyword">sizeof</span>($arr = $root-&gt;get_elements_by_tagname(<span class="stringliteral">"proxyTicket"</span>)) != 0) {
01606                                         $err_code = <a class="code" href="group__publicServices.html#ga2">PHPCAS_SERVICE_OK</a>;
01607                                         $err_msg = '';
01608                                         <a class="code" href="group__internalDebug.html#ga3">phpCAS::trace</a>('original PT: '.trim($arr[0]-&gt;get_content()));
01609                                         $pt = trim($arr[0]-&gt;get_content());
01610                                         <a class="code" href="group__internalDebug.html#ga5">phpCAS::traceEnd</a>($pt);
01611                                         <span class="keywordflow">return</span> $pt;
01612                                 } <span class="keywordflow">else</span> {
01613                                         <a class="code" href="group__internalDebug.html#ga3">phpCAS::trace</a>('&lt;proxySuccess&gt; was found, but not &lt;proxyTicket&gt;');
01614                                 }
01615                         } 
01616                         <span class="comment">// look for a proxyFailure tag</span>
01617                         <span class="keywordflow">else</span> <span class="keywordflow">if</span> ( <span class="keyword">sizeof</span>($arr = $root-&gt;get_elements_by_tagname(<span class="stringliteral">"proxyFailure"</span>)) != 0) {
01618                                 <span class="comment">// authentication failed, extract the error</span>
01619                                 $err_code = <a class="code" href="group__publicServices.html#ga5">PHPCAS_SERVICE_PT_FAILURE</a>;
01620                                 $err_msg = 'PT retrieving failed (code=`'
01621                                         .$arr[0]-&gt;get_attribute('code')
01622                                         .<span class="charliteral">'\'</span>, message=`'
01623                                         .trim($arr[0]-&gt;get_content())
01624                                         .<span class="charliteral">'\'</span>)';
01625                                 <a class="code" href="group__internalDebug.html#ga5">phpCAS::traceEnd</a>(FALSE);
01626                                 <span class="keywordflow">return</span> FALSE;
01627                         } <span class="keywordflow">else</span> {
01628                                 <a class="code" href="group__internalDebug.html#ga3">phpCAS::trace</a>('neither &lt;proxySuccess&gt; nor &lt;proxyFailure&gt; found');
01629                         }
01630                 }
01631                 
01632                 <span class="comment">// at this step, we are sure that the response of the CAS server was ill-formed</span>
01633                 $err_code = <a class="code" href="group__publicServices.html#ga4">PHPCAS_SERVICE_PT_BAD_SERVER_RESPONSE</a>;
01634                 $err_msg = 'Invalid response from the CAS server (response=`'.$cas_response.<span class="charliteral">'\'</span>)';
01635                 
01636                 phpCAS::traceEnd(FALSE);
01637                 <span class="keywordflow">return</span> FALSE;
01638                 }
01639         
01640         <span class="comment">// ########################################################################</span>
01641         <span class="comment">// ACCESS TO EXTERNAL SERVICES</span>
01642         <span class="comment">// ########################################################################</span>
01643         
<a name="l01659"></a><a class="code" href="group__internalPGTStorage.html#ga10">01659</a>         function <a class="code" href="group__internalPGTStorage.html#ga10">readURL</a>($url,$cookies,&amp;$headers,&amp;$body,&amp;$err_msg)
01660                 {
01661                 <a class="code" href="group__internalDebug.html#ga4">phpCAS::traceBegin</a>();
01662                 $headers = '';
01663                 $body = '';
01664                 $err_msg = '';
01665                 
01666                 $res = TRUE;
01667                 
01668                 <span class="comment">// initialize the CURL session</span>
01669                 $ch = curl_init($url);
01670                 
01671                 <span class="keywordflow">if</span> ($this-&gt;_cas_server_cert == '' &amp;&amp; $this-&gt;_cas_server_ca_cert == '' &amp;&amp; !$this-&gt;_no_cas_server_validation) {
01672                         <a class="code" href="group__internalDebug.html#ga2">phpCAS::error</a>('one of the methods phpCAS::setCasServerCert(), phpCAS::setCasServerCACert() or phpCAS::setNoCasServerValidation() must be called.');
01673                 }
01674                 <span class="keywordflow">if</span> ($this-&gt;_cas_server_cert != '' ) {
01675                         curl_setopt($ch, CURLOPT_SSL_VERIFYPEER, 1);
01676                         curl_setopt($ch, CURLOPT_SSLCERT, $this-&gt;_cas_server_cert);
01677                 } <span class="keywordflow">else</span> <span class="keywordflow">if</span> ($this-&gt;_cas_server_ca_cert != '') {
01678                         curl_setopt($ch, CURLOPT_SSL_VERIFYPEER, 1);
01679                         curl_setopt($ch, CURLOPT_CAINFO, $this-&gt;_cas_server_ca_cert);
01680                 } <span class="keywordflow">else</span> {
01681                         curl_setopt($ch, CURLOPT_SSL_VERIFYHOST, 1);
01682                         curl_setopt($ch, CURLOPT_SSL_VERIFYPEER, 0);
01683                 }
01684                 
01685                 <span class="comment">// return the CURL output into a variable</span>
01686                 curl_setopt($ch, CURLOPT_RETURNTRANSFER, 1);
01687                 <span class="comment">// include the HTTP header with the body</span>
01688                 curl_setopt($ch, CURLOPT_HEADER, 1);
01689                 <span class="comment">// add cookies headers</span>
01690                 <span class="keywordflow">if</span> ( is_array($cookies) ) {
01691                         curl_setopt($ch,CURLOPT_COOKIE,implode(<span class="charliteral">';'</span>,$cookies));
01692                 }
01693                 <span class="comment">// perform the query</span>
01694                 $buf = curl_exec ($ch);
01695                 <span class="keywordflow">if</span> ( $buf === FALSE ) {
01696                         <a class="code" href="group__internalDebug.html#ga3">phpCAS::trace</a>('curl_exec() failed');
01697                         $err_msg = 'CURL error #'.curl_errno($ch).': '.curl_error($ch);
01698                         <span class="comment">// close the CURL session</span>
01699                         curl_close ($ch);
01700                         $res = FALSE;
01701                 } <span class="keywordflow">else</span> {
01702                         <span class="comment">// close the CURL session</span>
01703                         curl_close ($ch);
01704                         
01705                         <span class="comment">// find the end of the headers</span>
01706                         <span class="comment">// note: strpos($str,"\n\r\n\r") does not work (?)</span>
01707                         $pos = FALSE;
01708                         <span class="keywordflow">for</span> ($i=0; $i&lt;strlen($buf); $i++) {
01709                                 <span class="keywordflow">if</span> ( $buf[$i] == chr(13) ) 
01710                                         <span class="keywordflow">if</span> ( $buf[$i+1] == chr(10) ) 
01711                                                 <span class="keywordflow">if</span> ( $buf[$i+2] == chr(13) ) 
01712                                                         <span class="keywordflow">if</span> ( $buf[$i+3] == chr(10) ) {
01713                                                                 <span class="comment">// header found</span>
01714                                                                 $pos = $i;
01715                                                                 <span class="keywordflow">break</span>;
01716                                                         }
01717                         }
01718                         
01719                         <span class="keywordflow">if</span> ( $pos === FALSE ) {
01720                                 <span class="comment">// end of header not found</span>
01721                                 $err_msg = 'no header found';
01722                                 <a class="code" href="group__internalDebug.html#ga3">phpCAS::trace</a>($err_msg);
01723                                 $res = FALSE;
01724                         } <span class="keywordflow">else</span> { 
01725                                 <span class="comment">// extract headers into an array</span>
01726                                 $headers = preg_split (<span class="stringliteral">"/[\n\r]+/"</span>,substr($buf,0,$pos));          
01727                                 <span class="comment">// extract body into a string</span>
01728                                 $body = substr($buf,$pos+4);
01729                         }
01730                 }
01731                 
01732                 <a class="code" href="group__internalDebug.html#ga5">phpCAS::traceEnd</a>($res);
01733                 <span class="keywordflow">return</span> $res;
01734                 }
01735         
<a name="l01751"></a><a class="code" href="group__internalPGTStorage.html#ga11">01751</a>         function <a class="code" href="group__internalPGTStorage.html#ga11">serviceWeb</a>($url,&amp;$err_code,&amp;$output)
01752                 {
01753                 <a class="code" href="group__internalDebug.html#ga4">phpCAS::traceBegin</a>();
01754                 <span class="comment">// at first retrieve a PT</span>
01755                 $pt = $this-&gt;<a class="code" href="group__internalPGTStorage.html#ga9">retrievePT</a>($url,$err_code,$output);
01756                 
01757                 $res = TRUE;
01758                 
01759                 <span class="comment">// test if PT was retrieved correctly</span>
01760                 <span class="keywordflow">if</span> ( !$pt ) {
01761                         <span class="comment">// note: $err_code and $err_msg are filled by CASClient::retrievePT()</span>
01762                         <a class="code" href="group__internalDebug.html#ga3">phpCAS::trace</a>('PT was not retrieved correctly');
01763                         $res = FALSE;
01764                 } <span class="keywordflow">else</span> {
01765                         <span class="comment">// add cookies if necessary</span>
01766                         <span class="keywordflow">if</span> ( is_array($_SESSION['<a class="code" href="classphpCAS.html">phpCAS</a>']['services'][$url]['cookies']) ) {
01767                                 foreach ( $_SESSION['<a class="code" href="classphpCAS.html">phpCAS</a>']['services'][$url]['cookies'] as $name =&gt; $val ) { 
01768                                         $cookies[] = $name.<span class="charliteral">'='</span>.$val;
01769                                 }
01770                         }
01771                         
01772                         <span class="comment">// build the URL including the PT</span>
01773                         <span class="keywordflow">if</span> ( strstr($url,<span class="charliteral">'?'</span>) === FALSE ) {
01774                                 $service_url = $url.'?ticket='.$pt;
01775                         } <span class="keywordflow">else</span> {
01776                                 $service_url = $url.'&amp;ticket='.$pt;
01777                         }
01778                         
01779                         <a class="code" href="group__internalDebug.html#ga3">phpCAS::trace</a>('reading URL`'.$service_url.<span class="charliteral">'\''</span>);
01780                         if ( !$this-&gt;readURL($service_url,$cookies,$headers,$output,$err_msg) ) {
01781                                 <a class="code" href="group__internalDebug.html#ga3">phpCAS::trace</a>('could not read URL`'.$service_url.<span class="charliteral">'\''</span>);
01782                                 $err_code = PHPCAS_SERVICE_NOT_AVAILABLE;
01783                                 <span class="comment">// give an error message</span>
01784                                 $output = sprintf($this-&gt;getString(<a class="code" href="languages_8php.html#a6">CAS_STR_SERVICE_UNAVAILABLE</a>),
01785                                         $service_url,
01786                                         $err_msg);
01787                                 $res = FALSE;
01788                         } <span class="keywordflow">else</span> {
01789                                 <span class="comment">// URL has been fetched, extract the cookies</span>
01790                                 <a class="code" href="group__internalDebug.html#ga3">phpCAS::trace</a>('URL`'.$service_url.<span class="charliteral">'\'</span> has been read, storing cookies:');
01791                                 foreach ( $headers as $header ) {
01792                                         <span class="comment">// test if the header is a cookie</span>
01793                                         <span class="keywordflow">if</span> ( preg_match('/^Set-Cookie:/',$header) ) {
01794                                                 <span class="comment">// the header is a cookie, remove the beginning</span>
01795                                                 $header_val = preg_replace('/^Set-Cookie: */<span class="charliteral">','</span>',$header);
01796                                                 <span class="comment">// extract interesting information</span>
01797                                                 $name_val = strtok($header_val,'; ');
01798                                                 <span class="comment">// extract the name and the value of the cookie</span>
01799                                                 $cookie_name = strtok($name_val,<span class="charliteral">'='</span>);
01800                                                 $cookie_val = strtok(<span class="charliteral">'='</span>);
01801                                                 <span class="comment">// store the cookie </span>
01802                                                 $_SESSION['<a class="code" href="classphpCAS.html">phpCAS</a>']['services'][$url]['cookies'][$cookie_name] = $cookie_val;
01803                                                 <a class="code" href="group__internalDebug.html#ga3">phpCAS::trace</a>($cookie_name.' -&gt; '.$cookie_val);
01804                                         }
01805                                 }
01806                         }
01807                 }
01808                 
01809                 <a class="code" href="group__internalDebug.html#ga5">phpCAS::traceEnd</a>($res);
01810                 <span class="keywordflow">return</span> $res;
01811                 }
01812         
<a name="l01831"></a><a class="code" href="group__internalPGTStorage.html#ga12">01831</a>         function <a class="code" href="group__internalPGTStorage.html#ga12">serviceMail</a>($url,$flags,&amp;$err_code,&amp;$err_msg,&amp;$pt)
01832                 {
01833                 <a class="code" href="group__internalDebug.html#ga4">phpCAS::traceBegin</a>();
01834                 <span class="comment">// at first retrieve a PT</span>
01835                 $pt = $this-&gt;<a class="code" href="group__internalPGTStorage.html#ga9">retrievePT</a>($target_service,$err_code,$output);
01836                 
01837                 $stream = FALSE;
01838                 
01839                 <span class="comment">// test if PT was retrieved correctly</span>
01840                 <span class="keywordflow">if</span> ( !$pt ) {
01841                         <span class="comment">// note: $err_code and $err_msg are filled by CASClient::retrievePT()</span>
01842                         <a class="code" href="group__internalDebug.html#ga3">phpCAS::trace</a>('PT was not retrieved correctly');
01843                 } <span class="keywordflow">else</span> {
01844                         <a class="code" href="group__internalDebug.html#ga3">phpCAS::trace</a>('opening IMAP URL `'.$url.<span class="charliteral">'\'</span>...');
01845                         $stream = @imap_open($url,$this-&gt;getUser(),$pt,$flags);
01846                         <span class="keywordflow">if</span> ( !$stream ) {
01847                                 <a class="code" href="group__internalDebug.html#ga3">phpCAS::trace</a>('could not open URL');
01848                                 $err_code = PHPCAS_SERVICE_NOT_AVAILABLE;
01849                                 <span class="comment">// give an error message</span>
01850                                 $err_msg = sprintf($this-&gt;getString(<a class="code" href="languages_8php.html#a6">CAS_STR_SERVICE_UNAVAILABLE</a>),
01851                                         $service_url,
01852                                         var_export(imap_errors(),TRUE));
01853                                 $pt = FALSE;
01854                                 $stream = FALSE;
01855                         } <span class="keywordflow">else</span> {
01856                                 <a class="code" href="group__internalDebug.html#ga3">phpCAS::trace</a>('ok');
01857                         }
01858                 }
01859                 
01860                 <a class="code" href="group__internalDebug.html#ga5">phpCAS::traceEnd</a>($stream);
01861                 <span class="keywordflow">return</span> $stream;
01862                 }
01863         
01866         <span class="comment">// XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX</span>
01867         <span class="comment">// XX                                                                    XX</span>
01868         <span class="comment">// XX                  PROXIED CLIENT FEATURES (CAS 2.0)                 XX</span>
01869         <span class="comment">// XX                                                                    XX</span>
01870         <span class="comment">// XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX</span>
01871         
01872         <span class="comment">// ########################################################################</span>
01873         <span class="comment">//  PT</span>
01874         <span class="comment">// ########################################################################</span>
<a name="l01888"></a><a class="code" href="group__internalProxied.html#ga0">01888</a> <span class="comment"></span>        var <a class="code" href="group__internalProxied.html#ga0">$_pt</a> = '';
01889         
<a name="l01895"></a><a class="code" href="group__internalProxied.html#ga1">01895</a>         function <a class="code" href="group__internalProxied.html#ga1">getPT</a>()
01896                 {
01897                 <span class="comment">//      return 'ST'.substr($this-&gt;_pt, 2);</span>
01898                 <span class="keywordflow">return</span> $this-&gt;_pt;
01899                 }
01900         
<a name="l01906"></a><a class="code" href="group__internalProxied.html#ga2">01906</a>         function <a class="code" href="group__internalProxied.html#ga2">setPT</a>($pt)
01907                 { $this-&gt;_pt = $pt; }
01908         
<a name="l01914"></a><a class="code" href="group__internalProxied.html#ga3">01914</a>         function <a class="code" href="group__internalProxied.html#ga3">hasPT</a>()
01915                 { <span class="keywordflow">return</span> !empty($this-&gt;_pt); }
01916         
01918         <span class="comment">// ########################################################################</span>
01919         <span class="comment">//  PT VALIDATION</span>
01920         <span class="comment">// ########################################################################</span>
<a name="l01933"></a><a class="code" href="group__internalProxied.html#ga4">01933</a> <span class="comment"></span>        function <a class="code" href="group__internalProxied.html#ga4">validatePT</a>(&amp;$validate_url,&amp;$text_response,&amp;$tree_response)
01934                 {
01935                 <a class="code" href="group__internalDebug.html#ga4">phpCAS::traceBegin</a>();
01936                 <span class="comment">// build the URL to validate the ticket</span>
01937                 $validate_url = $this-&gt;<a class="code" href="group__internalConfig.html#ga9">getServerProxyValidateURL</a>().'&amp;ticket='.$this-&gt;getPT();
01938                 
01939                 <span class="keywordflow">if</span> ( $this-&gt;<a class="code" href="group__internalProxy.html#ga2">isProxy</a>() ) {
01940                         <span class="comment">// pass the callback url for CAS proxies</span>
01941                         $validate_url .= '&amp;pgtUrl='.$this-&gt;getCallbackURL();
01942                 }
01943                 
01944                 <span class="comment">// open and read the URL</span>
01945                 <span class="keywordflow">if</span> ( !$this-&gt;<a class="code" href="group__internalPGTStorage.html#ga10">readURL</a>($validate_url,''<span class="comment">/*cookies*/</span>,$headers,$text_response,$err_msg) ) {
01946                         <a class="code" href="group__internalDebug.html#ga3">phpCAS::trace</a>('could not open URL \''.$validate_url.<span class="charliteral">'\'</span> to validate ('.$err_msg.<span class="charliteral">')'</span>);
01947                         $this-&gt;authError('PT not validated',
01948                                 $validate_url,
01949                                 TRUE<span class="comment">/*$no_response*/</span>);
01950                 }
01951                 
01952                 <span class="comment">// read the response of the CAS server into a DOM object</span>
01953                 <span class="keywordflow">if</span> ( !($dom = <a class="code" href="domxml-php4-php5_8php.html#a2">domxml_open_mem</a>($text_response))) {
01954                         <span class="comment">// read failed</span>
01955                         $this-&gt;<a class="code" href="group__internalMisc.html#ga4">authError</a>('PT not validated',
01956                                 $validate_url,
01957                                 FALSE<span class="comment">/*$no_response*/</span>,
01958                                 TRUE<span class="comment">/*$bad_response*/</span>,
01959                                 $text_response);
01960                 }
01961                 <span class="comment">// read the root node of the XML tree</span>
01962                 <span class="keywordflow">if</span> ( !($tree_response = $dom-&gt;document_element()) ) {
01963                         <span class="comment">// read failed</span>
01964                         $this-&gt;<a class="code" href="group__internalMisc.html#ga4">authError</a>('PT not validated',
01965                                 $validate_url,
01966                                 FALSE<span class="comment">/*$no_response*/</span>,
01967                                 TRUE<span class="comment">/*$bad_response*/</span>,
01968                                 $text_response);
01969                 }
01970                 <span class="comment">// insure that tag name is 'serviceResponse'</span>
01971                 <span class="keywordflow">if</span> ( $tree_response-&gt;node_name() != 'serviceResponse' ) {
01972                         <span class="comment">// bad root node</span>
01973                         $this-&gt;<a class="code" href="group__internalMisc.html#ga4">authError</a>('PT not validated',
01974                                 $validate_url,
01975                                 FALSE<span class="comment">/*$no_response*/</span>,
01976                                 TRUE<span class="comment">/*$bad_response*/</span>,
01977                                 $text_response);
01978                 }
01979                 <span class="keywordflow">if</span> ( <span class="keyword">sizeof</span>($arr = $tree_response-&gt;get_elements_by_tagname(<span class="stringliteral">"authenticationSuccess"</span>)) != 0) {
01980                         <span class="comment">// authentication succeded, extract the user name</span>
01981                         <span class="keywordflow">if</span> ( <span class="keyword">sizeof</span>($arr = $tree_response-&gt;get_elements_by_tagname(<span class="stringliteral">"user"</span>)) == 0) {
01982                                 <span class="comment">// no user specified =&gt; error</span>
01983                                 $this-&gt;<a class="code" href="group__internalMisc.html#ga4">authError</a>('PT not validated',
01984                                         $validate_url,
01985                                         FALSE<span class="comment">/*$no_response*/</span>,
01986                                         TRUE<span class="comment">/*$bad_response*/</span>,
01987                                         $text_response);
01988                         }
01989                         $this-&gt;<a class="code" href="group__internalAuthentication.html#ga2">setUser</a>(trim($arr[0]-&gt;get_content()));
01990                         
01991                 } <span class="keywordflow">else</span> <span class="keywordflow">if</span> ( <span class="keyword">sizeof</span>($arr = $tree_response-&gt;get_elements_by_tagname(<span class="stringliteral">"authenticationFailure"</span>)) != 0) {
01992                         <span class="comment">// authentication succeded, extract the error code and message</span>
01993                         $this-&gt;<a class="code" href="group__internalMisc.html#ga4">authError</a>('PT not validated',
01994                                 $validate_url,
01995                                 FALSE<span class="comment">/*$no_response*/</span>,
01996                                 FALSE<span class="comment">/*$bad_response*/</span>,
01997                                 $text_response,
01998                                 $arr[0]-&gt;get_attribute('code')<span class="comment">/*$err_code*/</span>,
01999                                 trim($arr[0]-&gt;get_content())<span class="comment">/*$err_msg*/</span>);
02000                 } <span class="keywordflow">else</span> {
02001                         $this-&gt;<a class="code" href="group__internalMisc.html#ga4">authError</a>('PT not validated',
02002                                 $validate_url,  
02003                                 FALSE<span class="comment">/*$no_response*/</span>,
02004                                 TRUE<span class="comment">/*$bad_response*/</span>,
02005                                 $text_response);
02006                 }
02007                 
02008                 <span class="comment">// at this step, PT has been validated and $this-&gt;_user has been set,</span>
02009                 
02010                 <a class="code" href="group__internalDebug.html#ga5">phpCAS::traceEnd</a>(TRUE);
02011                 <span class="keywordflow">return</span> TRUE;
02012                 }
02013         
02016         <span class="comment">// XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX</span>
02017         <span class="comment">// XX                                                                    XX</span>
02018         <span class="comment">// XX                               MISC                                 XX</span>
02019         <span class="comment">// XX                                                                    XX</span>
02020         <span class="comment">// XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX</span>
02021         
02027         <span class="comment">// ########################################################################</span>
02028         <span class="comment">//  URL</span>
02029         <span class="comment">// ########################################################################</span>
<a name="l02037"></a><a class="code" href="group__internalMisc.html#ga1">02037</a> <span class="comment"></span>        var <a class="code" href="group__internalMisc.html#ga1">$_url</a> = '';
02038         
<a name="l02047"></a><a class="code" href="group__internalMisc.html#ga2">02047</a>         function <a class="code" href="group__internalMisc.html#ga2">getURL</a>()
02048                 {
02049                 <a class="code" href="group__internalDebug.html#ga4">phpCAS::traceBegin</a>();
02050                 <span class="comment">// the URL is built when needed only</span>
02051                 <span class="keywordflow">if</span> ( empty($this-&gt;_url) ) {
02052                         $final_uri = '';
02053                         <span class="comment">// remove the ticket if present in the URL</span>
02054                         $final_uri = ($this-&gt;<a class="code" href="group__internalConfig.html#ga13">isHttps</a>()) ? 'https' : 'http';
02055                         $final_uri .= ':<span class="comment">//';</span>
02056                         <span class="comment">/* replaced by Julien Marchal - v0.4.6</span>
02057 <span class="comment">                         * $this-&gt;_url .= $_SERVER['SERVER_NAME'];</span>
02058 <span class="comment">                         */</span>
02059                         <span class="keywordflow">if</span>(empty($_SERVER['HTTP_X_FORWARDED_SERVER'])){
02060                                 <span class="comment">/* replaced by teedog - v0.4.12</span>
02061 <span class="comment">                                 * $this-&gt;_url .= $_SERVER['SERVER_NAME'];</span>
02062 <span class="comment">                                 */</span>
02063                                 <span class="keywordflow">if</span> (empty($_SERVER['SERVER_NAME'])) {
02064                                         $server_name = $_SERVER['HTTP_HOST'];
02065                                 } <span class="keywordflow">else</span> {
02066                                         $server_name = $_SERVER['SERVER_NAME'];
02067                                 }
02068                         } <span class="keywordflow">else</span> {
02069                                 $server_name = $_SERVER['HTTP_X_FORWARDED_SERVER'];
02070                         }
02071                         $final_uri .= $server_name;
02072                         <span class="keywordflow">if</span> (!strpos($server_name, <span class="charliteral">':'</span>)) {
02073                                 <span class="keywordflow">if</span> ( ($this-&gt;<a class="code" href="group__internalConfig.html#ga13">isHttps</a>() &amp;&amp; $_SERVER['SERVER_PORT']!=443)
02074                                                 || (!$this-&gt;<a class="code" href="group__internalConfig.html#ga13">isHttps</a>() &amp;&amp; $_SERVER['SERVER_PORT']!=80) ) {
02075                                         $final_uri .= <span class="charliteral">':'</span>;
02076                                         $final_uri .= $_SERVER['SERVER_PORT'];
02077                                 }
02078                         }
02079                         
02080                         $final_uri .= strtok($_SERVER['REQUEST_URI'],<span class="stringliteral">"?"</span>);
02081                         $cgi_params = <span class="charliteral">'?'</span>.strtok(<span class="stringliteral">"?"</span>);
02082                         <span class="comment">// remove the ticket if present in the CGI parameters</span>
02083                         $cgi_params = preg_replace('/&amp;ticket=[^&amp;]*/<span class="charliteral">','</span>',$cgi_params);
02084                         $cgi_params = preg_replace('/\?ticket=[^&amp;;]*/<span class="charliteral">','</span>?',$cgi_params);
02085                         $cgi_params = preg_replace('/\?%26/<span class="charliteral">','</span>?',$cgi_params);
02086                         $cgi_params = preg_replace('/\?&amp;/<span class="charliteral">','</span>?',$cgi_params);
02087                         $cgi_params = preg_replace('/\?$/<span class="charliteral">','</span>',$cgi_params);
02088                         $final_uri .= $cgi_params;
02089                         $this-&gt;<a class="code" href="group__internalMisc.html#ga3">setURL</a>($final_uri);
02090                 }
02091                 <a class="code" href="group__internalDebug.html#ga5">phpCAS::traceEnd</a>($this-&gt;_url);
02092                 <span class="keywordflow">return</span> $this-&gt;_url;
02093                 }
02094         
<a name="l02102"></a><a class="code" href="group__internalMisc.html#ga3">02102</a>         function <a class="code" href="group__internalMisc.html#ga3">setURL</a>($url)
02103                 {
02104                 $this-&gt;_url = $url;
02105                 }
02106         
02107         <span class="comment">// ########################################################################</span>
02108         <span class="comment">//  AUTHENTICATION ERROR HANDLING</span>
02109         <span class="comment">// ########################################################################</span>
<a name="l02125"></a><a class="code" href="group__internalMisc.html#ga4">02125</a> <span class="comment"></span>        function <a class="code" href="group__internalMisc.html#ga4">authError</a>($failure,$cas_url,$no_response,$bad_response='',$cas_response='',$err_code='',$err_msg='')
02126                 {
02127                 <a class="code" href="group__internalDebug.html#ga4">phpCAS::traceBegin</a>();
02128                 
02129                 $this-&gt;<a class="code" href="group__internalOutput.html#ga3">printHTMLHeader</a>($this-&gt;getString(<a class="code" href="languages_8php.html#a4">CAS_STR_AUTHENTICATION_FAILED</a>));
02130                 printf($this-&gt;getString(<a class="code" href="languages_8php.html#a5">CAS_STR_YOU_WERE_NOT_AUTHENTICATED</a>),$this-&gt;<a class="code" href="group__internalMisc.html#ga2">getURL</a>(),$_SERVER['SERVER_ADMIN']);
02131                 <a class="code" href="group__internalDebug.html#ga3">phpCAS::trace</a>('CAS URL: '.$cas_url);
02132                 <a class="code" href="group__internalDebug.html#ga3">phpCAS::trace</a>('Authentication failure: '.$failure);
02133                 <span class="keywordflow">if</span> ( $no_response ) {
02134                         <a class="code" href="group__internalDebug.html#ga3">phpCAS::trace</a>('Reason: no response from the CAS server');
02135                 } <span class="keywordflow">else</span> {
02136                         <span class="keywordflow">if</span> ( $bad_response ) {
02137                                 <a class="code" href="group__internalDebug.html#ga3">phpCAS::trace</a>('Reason: bad response from the CAS server');
02138                         } <span class="keywordflow">else</span> {
02139                                 <span class="keywordflow">switch</span> ($this-&gt;<a class="code" href="group__internalConfig.html#ga1">getServerVersion</a>()) {
02140                                         <span class="keywordflow">case</span> <a class="code" href="group__public.html#ga1">CAS_VERSION_1_0</a>:
02141                                                 <a class="code" href="group__internalDebug.html#ga3">phpCAS::trace</a>('Reason: CAS error');
02142                                                 <span class="keywordflow">break</span>;
02143                                         <span class="keywordflow">case</span> <a class="code" href="group__public.html#ga2">CAS_VERSION_2_0</a>:
02144                                                 <span class="keywordflow">if</span> ( empty($err_code) )
02145                                                         <a class="code" href="group__internalDebug.html#ga3">phpCAS::trace</a>('Reason: no CAS error');
02146                                                 <span class="keywordflow">else</span>
02147                                                         <a class="code" href="group__internalDebug.html#ga3">phpCAS::trace</a>('Reason: ['.$err_code.'] CAS error: '.$err_msg);
02148                                                 <span class="keywordflow">break</span>;
02149                                 }
02150                         }
02151                         <a class="code" href="group__internalDebug.html#ga3">phpCAS::trace</a>('CAS response: '.$cas_response);
02152                 }
02153                 $this-&gt;<a class="code" href="group__internalOutput.html#ga4">printHTMLFooter</a>();
02154                 <a class="code" href="group__internalDebug.html#ga6">phpCAS::traceExit</a>();
02155                 exit();
02156                 }
02157         
02159 }
02160 
02161 ?&gt;
</pre></div><hr size="1"><address style="align: right;"><small>Generated on Fri May 2 11:03:57 2008 for phpCAS by
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border=0 > 
</a>1.3.6 </small></address>
</body>
</html>
